import '../../data/database/database.dart';

/// æ•°æ®åº“æœåŠ¡ - åº”ç”¨æ•°æ®æŒä¹…åŒ–çš„ç»Ÿä¸€è®¿é—®å…¥å£
///
/// DatabaseServiceæ˜¯æ•´ä¸ªåº”ç”¨æ•°æ®å­˜å‚¨çš„é—¨é¢æœåŠ¡ï¼Œæä¾›ï¼š
/// - ğŸ—ï¸ **ç»Ÿä¸€è®¿é—®**: ä¸ºæ‰€æœ‰Repositoryæä¾›ç»Ÿä¸€çš„æ•°æ®åº“è®¿é—®å…¥å£
/// - ğŸ”„ **è¿æ¥ç®¡ç†**: ç®¡ç†æ•°æ®åº“è¿æ¥çš„åˆ›å»ºã€å¤ç”¨å’Œå…³é—­
/// - ğŸ’¾ **å®ä¾‹æ§åˆ¶**: ç¡®ä¿å…¨åº”ç”¨ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“å®ä¾‹
/// - ğŸ›¡ï¸ **èµ„æºç®¡ç†**: è´Ÿè´£æ•°æ®åº“èµ„æºçš„æ­£ç¡®é‡Šæ”¾
///
/// ## ğŸ—ï¸ æ¶æ„è®¾è®¡
///
/// ### é—¨é¢æ¨¡å¼ (Facade Pattern)
/// ä¸ºå¤æ‚çš„Driftæ•°æ®åº“æ“ä½œæä¾›ç®€å•çš„è®¿é—®æ¥å£ï¼š
/// ```dart
/// final db = DatabaseService.instance.database;
/// ```
///
/// ### å•ä¾‹æ¨¡å¼
/// ç¡®ä¿å…¨åº”ç”¨ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼š
/// - é¿å…å¤šä¸ªæ•°æ®åº“å®ä¾‹
/// - å‡å°‘èµ„æºæ¶ˆè€—
/// - ä¿è¯æ•°æ®ä¸€è‡´æ€§
///
/// ### æ‡’åŠ è½½
/// æ•°æ®åº“å®ä¾‹åœ¨é¦–æ¬¡è®¿é—®æ—¶æ‰åˆ›å»ºï¼š
/// - å‡å°‘åº”ç”¨å¯åŠ¨æ—¶é—´
/// - æŒ‰éœ€åˆ†é…èµ„æº
/// - æ”¯æŒå¼‚æ­¥åˆå§‹åŒ–
///
/// ## ğŸ“Š åº•å±‚æ•°æ®åº“æ¶æ„
///
/// ä½¿ç”¨ **Drift ORM** ä½œä¸ºæ•°æ®è®¿é—®å±‚ï¼š
/// - **æ•°æ®åº“å¼•æ“**: SQLite
/// - **ORMæ¡†æ¶**: Drift (åŸMoor)
/// - **æ•°æ®åº“æ–‡ä»¶**: `yumcha.db`
/// - **å½“å‰ç‰ˆæœ¬**: 2
///
/// ### æ ¸å¿ƒæ•°æ®è¡¨
/// - **providers**: AIæä¾›å•†é…ç½® (OpenAI, Anthropicç­‰)
/// - **assistants**: AIåŠ©æ‰‹é…ç½® (ç³»ç»Ÿæç¤ºã€å‚æ•°ç­‰)
/// - **conversations**: å¯¹è¯å…ƒæ•°æ® (æ ‡é¢˜ã€æ—¶é—´ç­‰)
/// - **messages**: èŠå¤©æ¶ˆæ¯å†…å®¹ (ç”¨æˆ·/AIæ¶ˆæ¯)
/// - **favorite_models**: æ”¶è—çš„AIæ¨¡å‹
/// - **settings**: åº”ç”¨è®¾ç½®å’Œç”¨æˆ·åå¥½
///
/// ## ğŸš€ ä½¿ç”¨ç¤ºä¾‹
///
/// ### è·å–æ•°æ®åº“å®ä¾‹
/// ```dart
/// final dbService = DatabaseService.instance;
/// final db = dbService.database;
/// ```
///
/// ### åœ¨Repositoryä¸­ä½¿ç”¨
/// ```dart
/// class ConversationRepository {
///   final _db = DatabaseService.instance.database;
///
///   Future<List<ConversationData>> getAll() {
///     return _db.getAllConversations();
///   }
/// }
/// ```
///
/// ### åº”ç”¨å…³é—­æ—¶æ¸…ç†
/// ```dart
/// await DatabaseService.instance.close();
/// ```
///
/// ## âš™ï¸ æ€§èƒ½ç‰¹æ€§
/// - **è¿æ¥æ± **: è‡ªåŠ¨ç®¡ç†æ•°æ®åº“è¿æ¥
/// - **ç´¢å¼•ä¼˜åŒ–**: ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•
/// - **äº‹åŠ¡æ”¯æŒ**: æ”¯æŒACIDäº‹åŠ¡æ“ä½œ
/// - **è¿ç§»ç®¡ç†**: è‡ªåŠ¨å¤„ç†æ•°æ®åº“ç»“æ„å‡çº§
///
/// ## ğŸ”’ çº¿ç¨‹å®‰å…¨
/// - Drift ORMæœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„
/// - å•ä¾‹æ¨¡å¼ç¡®ä¿å®ä¾‹å”¯ä¸€æ€§
/// - æ”¯æŒå¤šä¸ªRepositoryå¹¶å‘è®¿é—®
class DatabaseService {
  /// å•ä¾‹å®ä¾‹
  static DatabaseService? _instance;

  /// æ•°æ®åº“å®ä¾‹
  ///
  /// ä½¿ç”¨æ‡’åŠ è½½æ¨¡å¼ï¼Œåœ¨é¦–æ¬¡è®¿é—®æ—¶åˆ›å»ºã€‚
  /// æ•´ä¸ªåº”ç”¨ç”Ÿå‘½å‘¨æœŸä¸­åªä¼šåˆ›å»ºä¸€ä¸ªå®ä¾‹ã€‚
  static AppDatabase? _database;

  /// ç§æœ‰æ„é€ å‡½æ•°ï¼Œé˜²æ­¢å¤–éƒ¨ç›´æ¥å®ä¾‹åŒ–
  DatabaseService._();

  /// è·å–å•ä¾‹å®ä¾‹
  ///
  /// ä½¿ç”¨æ‡’åŠ è½½æ¨¡å¼åˆ›å»ºå•ä¾‹å®ä¾‹ã€‚
  ///
  /// @returns DatabaseServiceçš„å”¯ä¸€å®ä¾‹
  static DatabaseService get instance {
    _instance ??= DatabaseService._();
    return _instance!;
  }

  /// è·å–æ•°æ®åº“å®ä¾‹
  ///
  /// æä¾›å¯¹åº•å±‚AppDatabaseçš„è®¿é—®ã€‚AppDatabaseåŒ…å«äº†æ‰€æœ‰çš„
  /// æ•°æ®è¡¨æ“ä½œæ–¹æ³•å’ŒæŸ¥è¯¢æ¥å£ã€‚
  ///
  /// ## ğŸ¯ åŠŸèƒ½ç‰¹æ€§
  /// - **è‡ªåŠ¨åˆå§‹åŒ–**: é¦–æ¬¡è®¿é—®æ—¶è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“
  /// - **è¿ç§»ç®¡ç†**: è‡ªåŠ¨å¤„ç†æ•°æ®åº“ç‰ˆæœ¬å‡çº§
  /// - **ç´¢å¼•ä¼˜åŒ–**: è‡ªåŠ¨åˆ›å»ºæ€§èƒ½ä¼˜åŒ–ç´¢å¼•
  /// - **äº‹åŠ¡æ”¯æŒ**: æ”¯æŒå¤æ‚çš„äº‹åŠ¡æ“ä½œ
  ///
  /// @returns AppDatabaseå®ä¾‹ï¼ŒåŒ…å«æ‰€æœ‰æ•°æ®æ“ä½œæ–¹æ³•
  ///
  /// ## ä½¿ç”¨ç¤ºä¾‹
  /// ```dart
  /// final db = DatabaseService.instance.database;
  ///
  /// // æŸ¥è¯¢æ‰€æœ‰å¯¹è¯
  /// final conversations = await db.getAllConversations();
  ///
  /// // æ’å…¥æ–°æ¶ˆæ¯
  /// await db.insertMessage(MessagesCompanion.insert(
  ///   id: messageId,
  ///   conversationId: conversationId,
  ///   content: content,
  ///   isFromUser: true,
  ///   timestamp: DateTime.now(),
  /// ));
  /// ```
  AppDatabase get database {
    _database ??= AppDatabase();
    return _database!;
  }

  /// å…³é—­æ•°æ®åº“è¿æ¥
  ///
  /// æ­£ç¡®å…³é—­æ•°æ®åº“è¿æ¥å¹¶é‡Šæ”¾ç›¸å…³èµ„æºã€‚åº”è¯¥åœ¨åº”ç”¨å…³é—­æ—¶è°ƒç”¨ã€‚
  ///
  /// ## ğŸ§¹ æ¸…ç†æ“ä½œ
  /// - å…³é—­æ•°æ®åº“è¿æ¥
  /// - é‡Šæ”¾æ–‡ä»¶å¥æŸ„
  /// - æ¸…ç©ºå®ä¾‹ç¼“å­˜
  /// - å‡†å¤‡ä¸‹æ¬¡é‡æ–°åˆå§‹åŒ–
  ///
  /// ## âš ï¸ æ³¨æ„äº‹é¡¹
  /// - å…³é—­åå†æ¬¡è®¿é—®databaseä¼šé‡æ–°åˆ›å»ºå®ä¾‹
  /// - ç¡®ä¿æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„æ•°æ®åº“æ“ä½œ
  /// - é€šå¸¸åœ¨åº”ç”¨é€€å‡ºæ—¶è°ƒç”¨
  ///
  /// ## ä½¿ç”¨ç¤ºä¾‹
  /// ```dart
  /// // åº”ç”¨å…³é—­æ—¶
  /// @override
  /// void dispose() {
  ///   DatabaseService.instance.close();
  ///   super.dispose();
  /// }
  /// ```
  Future<void> close() async {
    await _database?.close();
    _database = null;
  }
}
