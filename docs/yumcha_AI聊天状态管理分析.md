# ğŸ—ï¸ YumCha AIèŠå¤© RiverpodçŠ¶æ€ç®¡ç†åˆ†ææŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

YumChaæ˜¯ä¸€ä¸ªåŸºäºFlutterçš„AIèŠå¤©å®¢æˆ·ç«¯ï¼Œé‡‡ç”¨RiverpodçŠ¶æ€ç®¡ç†æ¶æ„ã€‚æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æäº†ä»æ•°æ®åº“è¯»å–åˆ°èŠå¤©ç•Œé¢æ°”æ³¡æ˜¾ç¤ºçš„å®Œæ•´çŠ¶æ€ç®¡ç†æµç¨‹ï¼Œä»¥åŠAIèŠå¤©ç›¸å…³çš„æ‰€æœ‰Providerã€‚

## ğŸ›ï¸ æ¶æ„æ¦‚è§ˆ

YumCaé‡‡ç”¨8å±‚Riverpodæ¶æ„ï¼Œå…±71ä¸ªProviderï¼Œéµå¾ªä¾èµ–æ³¨å…¥å’Œå•ä¸€èŒè´£åŸåˆ™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UI Layer (Widgets)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Provider Layer (State Management)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç»Ÿä¸€AIç®¡ç†  â”‚ ç»Ÿä¸€èŠå¤©    â”‚ MCPæœåŠ¡     â”‚ è®¾ç½®ç®¡ç†    â”‚  â”‚
â”‚  â”‚   (17ä¸ª)    â”‚   (18ä¸ª)    â”‚   (7ä¸ª)     â”‚   (8ä¸ª)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   æœç´¢åŠŸèƒ½  â”‚ åº”ç”¨åˆå§‹åŒ–  â”‚ å…¶ä»–åŠŸèƒ½    â”‚ åŸºç¡€æœåŠ¡    â”‚  â”‚
â”‚  â”‚   (3ä¸ª)     â”‚   (4ä¸ª)     â”‚   (6ä¸ª)     â”‚   (8ä¸ª)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                Repository Layer (Data Access)              â”‚
â”‚                        (6ä¸ªRepository)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               Service Layer (Infrastructure)               â”‚
â”‚              (Database + Preference + MCP)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ æ ¸å¿ƒçŠ¶æ€ç®¡ç†æ¨¡å—

### 1. ç»Ÿä¸€AIç®¡ç†å±‚ (17ä¸ªProvider) â­ æ ¸å¿ƒæ¶æ„

#### æ ¸å¿ƒProvider
- **`unifiedAiManagementProvider`** - ç»Ÿä¸€AIç®¡ç†çŠ¶æ€
  - æ–‡ä»¶ï¼š`lib/features/ai_management/presentation/providers/unified_ai_management_notifier.dart`
  - è¡Œæ•°ï¼šç¬¬15-18è¡Œ
  - ä¸»è¦æ–¹æ³•ï¼š
    - `addCustomProvider()` (ç¬¬142-170è¡Œ) - æ·»åŠ è‡ªå®šä¹‰AIæä¾›å•†
    - `createCustomAssistant()` - åˆ›å»ºè‡ªå®šä¹‰AIåŠ©æ‰‹
    - `selectAssistant()` - é€‰æ‹©AIåŠ©æ‰‹
    - `testProviderConnection()` - æµ‹è¯•æä¾›å•†è¿æ¥

#### AIæä¾›å•†ç›¸å…³Provider (4ä¸ª)
- **`aiProvidersProvider`** - æ‰€æœ‰AIæä¾›å•†åˆ—è¡¨
- **`enabledAiProvidersProvider`** - å¯ç”¨çš„æä¾›å•†åˆ—è¡¨  
- **`connectedAiProvidersProvider`** - å·²è¿æ¥çš„æä¾›å•†åˆ—è¡¨
- **`favoriteAiProvidersProvider`** - æ”¶è—çš„æä¾›å•†åˆ—è¡¨

#### AIåŠ©æ‰‹ç›¸å…³Provider (4ä¸ª)
- **`aiAssistantsProvider`** - æ‰€æœ‰AIåŠ©æ‰‹åˆ—è¡¨
- **`enabledAiAssistantsProvider`** - å¯ç”¨çš„åŠ©æ‰‹åˆ—è¡¨
- **`defaultAiAssistantProvider`** - é»˜è®¤åŠ©æ‰‹
- **`favoriteAiAssistantsProvider`** - æ”¶è—çš„åŠ©æ‰‹åˆ—è¡¨

#### AIæ¨¡å‹ç›¸å…³Provider (3ä¸ª)
- **`aiModelsProvider`** - æ‰€æœ‰AIæ¨¡å‹åˆ—è¡¨
- **`compatibleModelsProvider`** - å…¼å®¹çš„æ¨¡å‹åˆ—è¡¨
- **`favoriteModelsProvider`** - æ”¶è—çš„æ¨¡å‹åˆ—è¡¨

### 2. ç»Ÿä¸€èŠå¤©çŠ¶æ€å±‚ (18ä¸ªProvider) â­ äº‹ä»¶é©±åŠ¨

#### æ ¸å¿ƒProvider
- **`unifiedChatProvider`** - ç»Ÿä¸€èŠå¤©çŠ¶æ€ç®¡ç†
  - æ–‡ä»¶ï¼š`lib/features/chat/presentation/providers/unified_chat_notifier.dart`
  - è¡Œæ•°ï¼šç¬¬1834-1837è¡Œ
  - ä¸»è¦æ–¹æ³•ï¼š
    - `sendMessage()` - å‘é€æ¶ˆæ¯
    - `_processStreamingUpdate()` (ç¬¬1149-1178è¡Œ) - å¤„ç†æµå¼æ›´æ–°
    - `_updateUserMessageContent()` (ç¬¬1814-1828è¡Œ) - æ›´æ–°ç”¨æˆ·æ¶ˆæ¯å†…å®¹

#### ä¾¿æ·è®¿é—®Provider (13ä¸ª)
- **`chatMessagesProvider`** - èŠå¤©æ¶ˆæ¯åˆ—è¡¨ (ç¬¬1847-1849è¡Œ)
- **`currentConversationProvider`** - å½“å‰å¯¹è¯ (ç¬¬1851-1853è¡Œ)
- **`chatConfigurationProvider`** - èŠå¤©é…ç½® (ç¬¬1858-1860è¡Œ)
- **`chatLoadingStateProvider`** - åŠ è½½çŠ¶æ€ (ç¬¬1863-1866è¡Œ)
- **`chatErrorProvider`** - é”™è¯¯ä¿¡æ¯ (ç¬¬1868-1871è¡Œ)
- **`chatReadyStateProvider`** - å‡†å¤‡çŠ¶æ€ (ç¬¬1873-1876è¡Œ)
- **`streamingMessagesProvider`** - æµå¼æ¶ˆæ¯ (ç¬¬1878-1882è¡Œ)
- **`selectedAssistantProvider`** - é€‰ä¸­åŠ©æ‰‹
- **`selectedProviderProvider`** - é€‰ä¸­æä¾›å•†
- **`selectedModelProvider`** - é€‰ä¸­æ¨¡å‹
- **`hasStreamingMessagesProvider`** - æ˜¯å¦æœ‰æµå¼æ¶ˆæ¯ (ç¬¬1884-1888è¡Œ)
- **`messageCountProvider`** - æ¶ˆæ¯æ•°é‡ (ç¬¬1890-1894è¡Œ)
- **`currentConversationIdProvider`** - å½“å‰å¯¹è¯ID

#### äº‹ä»¶å’Œç»Ÿè®¡Provider (3ä¸ª)
- **`chatEventProvider`** - èŠå¤©äº‹ä»¶æµ (ç¬¬1896-1900è¡Œ)
- **`chatStatisticsProvider`** - èŠå¤©ç»Ÿè®¡ä¿¡æ¯
- **`chatPerformanceProvider`** - æ€§èƒ½æŒ‡æ ‡

### 3. æ¶ˆæ¯å’Œæ•°æ®åº“ç®¡ç†

#### Repositoryå±‚ (6ä¸ª)
- **`messageRepositoryProvider`** - æ¶ˆæ¯æ•°æ®è®¿é—®
  - æ–‡ä»¶ï¼š`lib/features/chat/presentation/providers/chat_providers.dart`
  - è¡Œæ•°ï¼šç¬¬12-15è¡Œ
- **`conversationRepositoryProvider`** - å¯¹è¯æ•°æ®è®¿é—®
  - æ–‡ä»¶ï¼š`lib/shared/presentation/providers/dependency_providers.dart`
  - è¡Œæ•°ï¼šç¬¬85-88è¡Œ
- **`providerRepositoryProvider`** - AIæä¾›å•†æ•°æ®è®¿é—® (ç¬¬64-67è¡Œ)
- **`assistantRepositoryProvider`** - AIåŠ©æ‰‹æ•°æ®è®¿é—® (ç¬¬72-75è¡Œ)
- **`favoriteModelRepositoryProvider`** - æ”¶è—æ¨¡å‹æ•°æ®è®¿é—® (ç¬¬80-83è¡Œ)
- **`settingRepositoryProvider`** - è®¾ç½®æ•°æ®è®¿é—® (ç¬¬90-93è¡Œ)

#### åŸºç¡€æœåŠ¡å±‚ (2ä¸ª)
- **`databaseProvider`** - æ•°æ®åº“å®ä¾‹æä¾›
  - æ–‡ä»¶ï¼š`lib/shared/presentation/providers/dependency_providers.dart`
  - è¡Œæ•°ï¼šç¬¬33-35è¡Œ
- **`preferenceServiceProvider`** - åå¥½è®¾ç½®æœåŠ¡ (ç¬¬41-43è¡Œ)

### 4. è®¾ç½®ç®¡ç†å±‚ (8ä¸ªProvider)

#### æ ¸å¿ƒè®¾ç½®Provider
- **`settingsNotifierProvider`** - è®¾ç½®çŠ¶æ€ç®¡ç†
  - æ–‡ä»¶ï¼š`lib/features/settings/presentation/providers/settings_notifier.dart`
  - è¡Œæ•°ï¼šç¬¬382-385è¡Œ
  - ä¸»è¦æ–¹æ³•ï¼š
    - `setDefaultChatModel()` (ç¬¬200-207è¡Œ) - è®¾ç½®é»˜è®¤èŠå¤©æ¨¡å‹
    - `setColorMode()` (ç¬¬238-245è¡Œ) - è®¾ç½®é¢œè‰²æ¨¡å¼
    - `setMcpServers()` (ç¬¬371-378è¡Œ) - è®¾ç½®MCPæœåŠ¡å™¨é…ç½®

- **`multimediaSettingsProvider`** - å¤šåª’ä½“è®¾ç½®
  - æ–‡ä»¶ï¼š`lib/features/settings/presentation/providers/multimedia_settings_notifier.dart`
  - è¡Œæ•°ï¼šç¬¬28-34è¡Œ

#### è®¾ç½®è®¿é—®Provider (6ä¸ª)
- **`settingValueProvider`** - ç‰¹å®šè®¾ç½®å€¼ (ç¬¬388-392è¡Œ)
- **`defaultChatModelProvider`** - é»˜è®¤èŠå¤©æ¨¡å‹ (ç¬¬395-401è¡Œ)
- **`defaultTitleModelProvider`** - é»˜è®¤æ ‡é¢˜æ¨¡å‹ (ç¬¬403-409è¡Œ)
- **`defaultTranslationModelProvider`** - é»˜è®¤ç¿»è¯‘æ¨¡å‹
- **`defaultSummaryModelProvider`** - é»˜è®¤æ‘˜è¦æ¨¡å‹
- **`themeNotifierProvider`** - ä¸»é¢˜è®¾ç½®

### 5. MCPæœåŠ¡å±‚ (7ä¸ªProvider) â­ å¹³å°é€‚é…

#### æ ¸å¿ƒMCPæœåŠ¡
- **`mcpServiceManagerProvider`** - MCPæœåŠ¡ç®¡ç†å™¨
  - æ–‡ä»¶ï¼š`lib/shared/infrastructure/services/mcp/mcp_service_manager.dart`
  - è¡Œæ•°ï¼šç¬¬10-20è¡Œ
- **`mcpServiceProvider`** - MCPæœåŠ¡çŠ¶æ€ç®¡ç†
  - æ–‡ä»¶ï¼š`lib/features/settings/presentation/providers/mcp_service_provider.dart`
  - è¡Œæ•°ï¼šç¬¬8-22è¡Œ

#### MCPçŠ¶æ€ç®¡ç†Provider (5ä¸ª)
- **`mcpServerStateProvider`** - MCPæœåŠ¡å™¨çŠ¶æ€
  - æ–‡ä»¶ï¼š`lib/features/mcp/presentation/providers/mcp_server_state_provider.dart`
  - è¡Œæ•°ï¼šç¬¬10-15è¡Œ
- **`mcpServerStatusProvider`** - ç‰¹å®šæœåŠ¡å™¨çŠ¶æ€
- **`mcpServerErrorProvider`** - æœåŠ¡å™¨é”™è¯¯ä¿¡æ¯
- **`mcpServerToolsProvider`** - æœåŠ¡å™¨å·¥å…·åˆ—è¡¨
- **`mcpAllToolsProvider`** - æ‰€æœ‰å¯ç”¨å·¥å…·

### 6. æœç´¢åŠŸèƒ½å±‚ (3ä¸ªProvider)

- **`searchResultsProvider`** - æœç´¢ç»“æœç®¡ç†
  - æ–‡ä»¶ï¼š`lib/features/chat/presentation/providers/chat_search_providers.dart`
  - è¡Œæ•°ï¼šç¬¬18-21è¡Œ
  - ä¸»è¦æ–¹æ³•ï¼š
    - `_performSearch()` (ç¬¬208-257è¡Œ) - æ‰§è¡Œæœç´¢
    - `loadMore()` (ç¬¬155-187è¡Œ) - åŠ è½½æ›´å¤šç»“æœ
- **`searchQueryProvider`** - æœç´¢æŸ¥è¯¢çŠ¶æ€ (ç¬¬8è¡Œ)
- **`searchTypeProvider`** - æœç´¢ç±»å‹é€‰æ‹© (ç¬¬14-15è¡Œ)

### 7. åº”ç”¨åˆå§‹åŒ–å±‚ (4ä¸ªProvider)

- **`appInitializationProvider`** - åº”ç”¨åˆå§‹åŒ–ç®¡ç†
  - æ–‡ä»¶ï¼š`lib/shared/presentation/providers/app_initialization_provider.dart`
  - è¡Œæ•°ï¼šç¬¬149-185è¡Œ
  - ä¸»è¦æ–¹æ³•ï¼š
    - `_initializeBasicServices()` (ç¬¬195-222è¡Œ) - åˆå§‹åŒ–åŸºç¡€æœåŠ¡
    - `_initializeData()` (ç¬¬266-289è¡Œ) - åˆå§‹åŒ–æ•°æ®
- **`initializeDefaultDataProvider`** - é»˜è®¤æ•°æ®åˆå§‹åŒ–
- **`aiServiceManagerProvider`** - AIæœåŠ¡ç®¡ç†å™¨
- **`initializeAiServicesProvider`** - AIæœåŠ¡åˆå§‹åŒ–

### 8. å…¶ä»–åŠŸèƒ½Provider (12ä¸ª) â­ è¡¥å……é—æ¼

#### æ ¸å¿ƒåŠŸèƒ½Provider (6ä¸ª)
- **`favoriteModelNotifierProvider`** - æ”¶è—æ¨¡å‹ç®¡ç†
  - æ–‡ä»¶ï¼š`lib/shared/presentation/providers/favorite_model_notifier.dart`
  - è¡Œæ•°ï¼šç¬¬30-34è¡Œ
  - ä¸»è¦æ–¹æ³•ï¼š
    - `addFavoriteModel()` (ç¬¬77-113è¡Œ) - æ·»åŠ æ”¶è—æ¨¡å‹
    - `toggleFavoriteModel()` (ç¬¬144-156è¡Œ) - åˆ‡æ¢æ”¶è—çŠ¶æ€
- **`conversationTitleNotifier`** - å¯¹è¯æ ‡é¢˜ç®¡ç†
  - æ–‡ä»¶ï¼š`lib/shared/presentation/providers/conversation_title_notifier.dart`
  - è¡Œæ•°ï¼šç¬¬20-22è¡Œ
  - ä¸»è¦æ–¹æ³•ï¼š
    - `generateTitle()` (ç¬¬107-139è¡Œ) - ç”Ÿæˆå¯¹è¯æ ‡é¢˜
- **`configurationPersistenceNotifierProvider`** - é…ç½®æŒä¹…åŒ–
- **`conversationServiceProvider`** - å¯¹è¯æœåŠ¡
- **`chatConfigurationNotifierProvider`** - èŠå¤©é…ç½®ç®¡ç†
- **`chatStatusSummaryProvider`** - èŠå¤©çŠ¶æ€æ‘˜è¦
  - æ–‡ä»¶ï¼š`lib/features/chat/presentation/providers/chat_status_summary_provider.dart`
  - è¡Œæ•°ï¼šç¬¬11-28è¡Œ

#### æµå¼æ¶ˆæ¯å¤„ç†Provider (3ä¸ª) â­ æ–°å‘ç°
- **`streamingMessageServiceProvider`** - æµå¼æ¶ˆæ¯æœåŠ¡
  - æ–‡ä»¶ï¼š`lib/features/chat/presentation/providers/streaming_message_provider.dart`
  - è¡Œæ•°ï¼šç¬¬7-11è¡Œ
  - ä¾èµ–ï¼š`messageRepositoryProvider`
- **`streamingMessageUpdateStreamProvider`** - æµå¼æ¶ˆæ¯æ›´æ–°æµ
  - æ–‡ä»¶ï¼š`lib/features/chat/presentation/providers/streaming_message_provider.dart`
  - è¡Œæ•°ï¼šç¬¬14-18è¡Œ
  - ä¾èµ–ï¼š`streamingMessageServiceProvider`
- **`messageIdManagerProvider`** - æ¶ˆæ¯IDç®¡ç†å™¨
  - æ–‡ä»¶ï¼š`lib/features/chat/presentation/providers/message_id_manager_provider.dart`
  - è¡Œæ•°ï¼šç¬¬8-11è¡Œ
  - ä¾èµ–ï¼š`messageIdServiceProvider`

#### UIæ ·å¼ç®¡ç†Provider (3ä¸ª) â­ æ–°å‘ç°
- **`chatStyleProvider`** - èŠå¤©æ ·å¼ç®¡ç†
  - æ–‡ä»¶ï¼š`lib/features/chat/presentation/providers/chat_style_provider.dart`
  - è¡Œæ•°ï¼šç¬¬123-126è¡Œ
  - ä¾èµ–ï¼š`preferenceServiceProvider`
  - ä¸»è¦æ–¹æ³•ï¼š
    - `updateStyle()` (ç¬¬95-114è¡Œ) - æ›´æ–°èŠå¤©æ ·å¼
    - `reload()` (ç¬¬117-119è¡Œ) - é‡æ–°åŠ è½½æ ·å¼
- **`currentChatStyleProvider`** - å½“å‰èŠå¤©æ ·å¼
  - æ–‡ä»¶ï¼š`lib/features/chat/presentation/providers/chat_style_provider.dart`
  - è¡Œæ•°ï¼šç¬¬129-131è¡Œ
  - ä¾èµ–ï¼š`chatStyleProvider`
- **`activeStreamingMessageIdsProvider`** - æ´»è·ƒæµå¼æ¶ˆæ¯IDåˆ—è¡¨
  - æ–‡ä»¶ï¼š`lib/features/chat/presentation/providers/message_id_manager_provider.dart`
  - è¡Œæ•°ï¼šç¬¬16-19è¡Œ
  - ä¾èµ–ï¼š`messageIdManagerProvider`

## ğŸ“Š æ•°æ®æµå‘åˆ†æ

### ä»æ•°æ®åº“åˆ°èŠå¤©æ°”æ³¡çš„å®Œæ•´æµç¨‹ â­ è¯¦ç»†è¡¥å……

#### ğŸ”„ æ ‡å‡†æ¶ˆæ¯æµç¨‹
1. **æ•°æ®åº“å±‚** â†’ `databaseProvider` â†’ å„ç§Repository
2. **Repositoryå±‚** â†’ `messageRepositoryProvider` â†’ æ¶ˆæ¯æ•°æ®è®¿é—®
3. **çŠ¶æ€ç®¡ç†å±‚** â†’ `unifiedChatProvider` â†’ ç»Ÿä¸€èŠå¤©çŠ¶æ€
4. **UIè®¿é—®å±‚** â†’ `chatMessagesProvider` â†’ æ¶ˆæ¯åˆ—è¡¨
5. **æ ·å¼ç®¡ç†å±‚** â†’ `chatStyleProvider` â†’ èŠå¤©æ ·å¼é…ç½®
6. **ç»„ä»¶æ¸²æŸ“å±‚** â†’ èŠå¤©æ°”æ³¡ç»„ä»¶ â†’ ç”¨æˆ·ç•Œé¢

#### ğŸŒŠ æµå¼æ¶ˆæ¯å¤„ç†æµç¨‹
1. **æ¶ˆæ¯åˆå§‹åŒ–** â†’ `messageIdManagerProvider` â†’ ç”Ÿæˆå”¯ä¸€æ¶ˆæ¯ID
2. **æµå¼æœåŠ¡å¯åŠ¨** â†’ `streamingMessageServiceProvider` â†’ å¼€å§‹æµå¼å¤„ç†
3. **å®æ—¶æ›´æ–°ç›‘å¬** â†’ `streamingMessageUpdateStreamProvider` â†’ ç›‘å¬æµå¼æ›´æ–°
4. **çŠ¶æ€åŒæ­¥** â†’ `unifiedChatProvider` â†’ æ›´æ–°èŠå¤©çŠ¶æ€
5. **UIå®æ—¶æ›´æ–°** â†’ `streamingMessagesProvider` â†’ æµå¼æ¶ˆæ¯åˆ—è¡¨
6. **å®Œæˆå¤„ç†** â†’ `chatEventProvider` â†’ å‘é€å®Œæˆäº‹ä»¶

#### ğŸ¨ æ ·å¼æ¸²æŸ“æµç¨‹
1. **æ ·å¼é…ç½®** â†’ `chatStyleProvider` â†’ åŠ è½½ç”¨æˆ·æ ·å¼åå¥½
2. **å½“å‰æ ·å¼** â†’ `currentChatStyleProvider` â†’ è·å–å½“å‰æ ·å¼
3. **æ¶ˆæ¯å—é€‚é…** â†’ `BubbleBlockRenderer` â†’ é€‚é…ä¸åŒæ¶ˆæ¯å—ç±»å‹
4. **åŠ¨æ€æ¸²æŸ“** â†’ èŠå¤©æ°”æ³¡ç»„ä»¶ â†’ åº”ç”¨æ ·å¼æ¸²æŸ“

### æ¶ˆæ¯å—æ¸²æŸ“ç³»ç»Ÿ â­ å¢å¼º

- **æ¶ˆæ¯å—é€‚é…å™¨** - `BubbleBlockRenderer`
  - æ–‡ä»¶ï¼š`lib/features/chat/presentation/widgets/bubble/bubble_block_renderer.dart`
  - è¡Œæ•°ï¼šç¬¬42-50è¡Œ
  - æ”¯æŒçš„å—ç±»å‹ï¼š
    - `mainText` - æ–‡æœ¬å—
    - `thinking` - æ€è€ƒè¿‡ç¨‹å—
    - `image` - å›¾åƒå—
    - `code` - ä»£ç å—
    - `tool` - å·¥å…·è°ƒç”¨å—
    - `file` - æ–‡ä»¶å—
    - `error` - é”™è¯¯å—
    - `citation` - å¼•ç”¨å—

#### ğŸ”§ æµå¼æ¶ˆæ¯å¤„ç†æœºåˆ¶
- **å¹¶å‘æ§åˆ¶** - æœ€å¤§5ä¸ªå¹¶å‘æµå¼æ¶ˆæ¯
- **è¶…æ—¶ç®¡ç†** - è‡ªåŠ¨è¶…æ—¶å–æ¶ˆæœºåˆ¶
- **å†…å­˜ä¼˜åŒ–** - æ™ºèƒ½æ¶ˆæ¯ä¿®å‰ªç­–ç•¥
- **é”™è¯¯æ¢å¤** - è‡ªåŠ¨é‡è¯•å’Œé™çº§å¤„ç†

## ğŸ”„ çŠ¶æ€åŒæ­¥æœºåˆ¶

### äº‹ä»¶é©±åŠ¨æ¶æ„
- ä½¿ç”¨`ChatEvent`è¿›è¡Œè·¨ç»„ä»¶é€šä¿¡
- æ”¯æŒæ¶ˆæ¯æ·»åŠ ã€æµå¼å¼€å§‹/å®Œæˆã€é”™è¯¯å¤„ç†ç­‰äº‹ä»¶
- é€šè¿‡`chatEventProvider`æä¾›äº‹ä»¶æµ

### å“åº”å¼æ›´æ–°
- ä½¿ç”¨ç»†ç²’åº¦ç›‘å¬é¿å…ä¸å¿…è¦çš„é‡å»º
- æ”¯æŒæµå¼æ¶ˆæ¯å®æ—¶æ›´æ–°
- æ™ºèƒ½çš„çŠ¶æ€ç¼“å­˜å’Œå†…å­˜ç®¡ç†

## ğŸ“ˆ æ¶æ„ä¼˜åŠ¿

1. **ğŸ”„ ä¾èµ–æ³¨å…¥ä¼˜åŠ¿** - ç»Ÿä¸€ç®¡ç†ï¼Œå¯æµ‹è¯•æ€§å¼º
2. **âš¡ æ€§èƒ½ä¼˜åŒ–ä¼˜åŠ¿** - æ™ºèƒ½ç¼“å­˜ï¼ŒæŒ‰éœ€åŠ è½½
3. **ğŸ›¡ï¸ ç±»å‹å®‰å…¨ä¼˜åŠ¿** - ç¼–è¯‘æ—¶æ£€æŸ¥ï¼ŒIDEæ”¯æŒå®Œæ•´
4. **ğŸ“ˆ å¯æ‰©å±•æ€§ä¼˜åŠ¿** - æ¨¡å—åŒ–è®¾è®¡ï¼Œæ’ä»¶æ¶æ„
5. **ğŸ”§ å¯ç»´æŠ¤æ€§ä¼˜åŠ¿** - åˆ†å±‚æ¸…æ™°ï¼Œä»£ç å¤ç”¨

## ğŸ“Š ç»Ÿè®¡æ€»ç»“ â­ æ›´æ–°

| å±‚çº§ | Provideræ•°é‡ | ä¸»è¦ç‰¹ç‚¹ |
|------|-------------|----------|
| **ç»Ÿä¸€AIç®¡ç†å±‚** | 17ä¸ª | æ–°æ¶æ„ï¼ŒåŠŸèƒ½å®Œæ•´ï¼Œæ€§èƒ½ä¼˜åŒ– |
| **ç»Ÿä¸€èŠå¤©çŠ¶æ€å±‚** | 18ä¸ª | äº‹ä»¶é©±åŠ¨ï¼Œç»Ÿä¸€çŠ¶æ€ç®¡ç† |
| **MCPæœåŠ¡å±‚** | 7ä¸ª | æ¶æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†ç¦» |
| **è®¾ç½®ç®¡ç†å±‚** | 8ä¸ª | å“åº”å¼ç›‘å¬ï¼Œæ‰¹é‡æ“ä½œæ”¯æŒ |
| **æœç´¢åŠŸèƒ½å±‚** | 3ä¸ª | é˜²æŠ–å¤„ç†ï¼Œåˆ†é¡µæ”¯æŒ |
| **åº”ç”¨åˆå§‹åŒ–å±‚** | 4ä¸ª | åˆ†å±‚åˆå§‹åŒ–ï¼Œä¾èµ–åè°ƒ |
| **å…¶ä»–åŠŸèƒ½** | 12ä¸ª | æµå¼å¤„ç†ï¼ŒUIæ ·å¼ï¼ŒåŠŸèƒ½æ‰©å±• |
| **åŸºç¡€æœåŠ¡å±‚** | 12ä¸ª | å•ä¾‹æ¨¡å¼ï¼Œä¾èµ–æ³¨å…¥è§„èŒƒ |
| **æ€»è®¡** | **81ä¸ª** | **æ¶æ„å®Œæ•´ï¼ŒåŠŸèƒ½ä¸°å¯Œ** |

### ğŸ” æ–°å‘ç°çš„é‡è¦Provider

#### æµå¼æ¶ˆæ¯å¤„ç†ç³»ç»Ÿ (3ä¸ª)
- ä¸“é—¨çš„æµå¼æ¶ˆæ¯æœåŠ¡ç®¡ç†
- æ¶ˆæ¯IDç”Ÿå‘½å‘¨æœŸç®¡ç†
- å®æ—¶æµå¼æ›´æ–°ç›‘å¬

#### UIæ ·å¼ç®¡ç†ç³»ç»Ÿ (3ä¸ª)
- èŠå¤©æ°”æ³¡æ ·å¼åŠ¨æ€åˆ‡æ¢
- ç”¨æˆ·åå¥½æŒä¹…åŒ–å­˜å‚¨
- å“åº”å¼æ ·å¼æ›´æ–°

#### å¢å¼ºçš„åŸºç¡€æœåŠ¡ (4ä¸ªæ–°å¢)
- å¤šåª’ä½“å­˜å‚¨æœåŠ¡
- æ¶ˆæ¯IDç”ŸæˆæœåŠ¡
- èŠå¤©é”™è¯¯å¤„ç†æœåŠ¡
- æ—¥å¿—è®°å½•æœåŠ¡

## ğŸ”§ å…³é”®å®ç°ç»†èŠ‚

### ç»Ÿä¸€AIç®¡ç†Providerå®ç°

```dart
// æ ¸å¿ƒçŠ¶æ€ç®¡ç†å™¨
final unifiedAiManagementProvider = StateNotifierProvider<
    UnifiedAiManagementNotifier, UnifiedAiManagementState>(
  (ref) => UnifiedAiManagementNotifier(ref),
);

// ä¾¿æ·è®¿é—®Providerç¤ºä¾‹
final aiProvidersProvider = Provider<List<AiProvider>>((ref) {
  return ref.watch(unifiedAiManagementProvider).providers;
});

final enabledAiProvidersProvider = Provider<List<AiProvider>>((ref) {
  final providers = ref.watch(aiProvidersProvider);
  return providers.where((p) => p.isEnabled).toList();
});
```

### ç»Ÿä¸€èŠå¤©Providerå®ç°

```dart
// æ ¸å¿ƒèŠå¤©çŠ¶æ€ç®¡ç†
final unifiedChatProvider =
    StateNotifierProvider<UnifiedChatNotifier, UnifiedChatState>(
  (ref) => UnifiedChatNotifier(ref),
);

// ç»†ç²’åº¦ç›‘å¬Provider
final chatMessagesProvider = Provider<List<Message>>((ref) {
  return ref.watch(unifiedChatProvider
      .select((state) => state.messageState.messages));
});

final streamingMessagesProvider = Provider<List<Message>>((ref) {
  return ref.watch(unifiedChatProvider
      .select((state) => state.messageState.streamingMessages));
});
```

### æ°”æ³¡æ¸²æŸ“ç³»ç»Ÿå®ç°

```dart
// æ¶ˆæ¯å—é€‚é…å™¨æ³¨å†Œ
void _registerBuiltinAdapters() {
  registerAdapter(MessageBlockType.mainText, TextBubbleAdapter());
  registerAdapter(MessageBlockType.thinking, ThinkingBubbleAdapter());
  registerAdapter(MessageBlockType.image, ImageBubbleAdapter());
  registerAdapter(MessageBlockType.code, CodeBubbleAdapter());
  registerAdapter(MessageBlockType.tool, ToolCallBubbleAdapter());
  registerAdapter(MessageBlockType.file, FileBubbleAdapter());
  registerAdapter(MessageBlockType.error, ErrorBubbleAdapter());
  registerAdapter(MessageBlockType.citation, QuoteBubbleAdapter());
}
```

## ğŸ¯ æœ€ä½³å®è·µç¤ºä¾‹

### 1. ä½¿ç”¨ç»Ÿä¸€èŠå¤©Providerå‘é€æ¶ˆæ¯

```dart
class ChatInputWidget extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return TextField(
      onSubmitted: (text) async {
        if (text.trim().isEmpty) return;

        // ç®€å•çš„APIè°ƒç”¨
        await ref.read(unifiedChatProvider.notifier).sendMessage(text);
      },
    );
  }
}
```

### 2. ç›‘å¬èŠå¤©äº‹ä»¶

```dart
class ChatEventHandler extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    ref.listen(chatEventProvider, (previous, next) {
      next.whenData((event) {
        switch (event.runtimeType) {
          case MessageAddedEvent:
            // å¤„ç†æ¶ˆæ¯æ·»åŠ äº‹ä»¶
            break;
          case StreamingStartedEvent:
            // å¤„ç†æµå¼å¼€å§‹äº‹ä»¶
            break;
          case StreamingCompletedEvent:
            // å¤„ç†æµå¼å®Œæˆäº‹ä»¶
            break;
        }
      });
    });

    return const SizedBox.shrink();
  }
}
```

### 3. ä½¿ç”¨AIç®¡ç†Provider

```dart
// è·å–AIæä¾›å•†åˆ—è¡¨
final providers = ref.watch(aiProvidersProvider);

// æ·»åŠ è‡ªå®šä¹‰æä¾›å•†
await ref.read(unifiedAiManagementProvider.notifier).addCustomProvider(
  name: 'My Provider',
  apiKey: 'sk-xxx',
  baseUrl: 'https://api.example.com',
);

// é€‰æ‹©åŠ©æ‰‹
await ref.read(unifiedAiManagementProvider.notifier).selectAssistant(assistant);
```

## ğŸ” å®Œæ•´ä¾èµ–å…³ç³»åˆ†æ

### ğŸ“Š è¯¦ç»†Providerä¾èµ–å…³ç³»å›¾

```mermaid
graph TD
    %% åŸºç¡€æœåŠ¡å±‚ - æ— ä¾èµ–çš„æ ¹èŠ‚ç‚¹
    DB[DatabaseService] --> DBP[databaseProvider]
    PS[PreferenceService] --> PSP[preferenceServiceProvider]
    LS[LoggerService] --> LSP[loggerServiceProvider]
    CEH[ChatErrorHandler] --> CEHP[chatErrorHandlerProvider]
    MSS[MediaStorageService] --> MSSP[mediaStorageServiceProvider]
    MIS[MessageIdService] --> MISP[messageIdServiceProvider]

    %% Repositoryå±‚ - ä¾èµ–æ•°æ®åº“Provider
    DBP --> PRP[providerRepositoryProvider]
    DBP --> ARP[assistantRepositoryProvider]
    DBP --> FRP[favoriteModelRepositoryProvider]
    DBP --> SRP[settingRepositoryProvider]
    DBP --> MRP[messageRepositoryProvider]

    %% å¯¹è¯Repositoryç‰¹æ®Šä¾èµ–
    DBP --> CRP[conversationRepositoryProvider]
    MRP --> CRP

    %% ç»Ÿä¸€AIç®¡ç†å±‚ - æ ¸å¿ƒçŠ¶æ€ç®¡ç†
    PRP --> UAMP[unifiedAiManagementProvider]
    ARP --> UAMP
    PSP --> UAMP

    %% AIç®¡ç†è¡ç”ŸProvider (17ä¸ª)
    UAMP --> AIPP[aiProvidersProvider]
    UAMP --> EAPP[enabledAiProvidersProvider]
    UAMP --> CAPP[connectedAiProvidersProvider]
    UAMP --> FAPP[favoriteAiProvidersProvider]
    UAMP --> AIAP[aiAssistantsProvider]
    UAMP --> EAAP[enabledAiAssistantsProvider]
    UAMP --> FAAP[favoriteAiAssistantsProvider]
    UAMP --> AICP[aiConfigurationProvider]
    UAMP --> SAP[selectedAssistantProvider]
    UAMP --> SPP[selectedProviderProvider]
    UAMP --> SMDP[selectedModelProvider]
    UAMP --> AMLP[aiManagementLoadingProvider]
    UAMP --> AMEP[aiManagementErrorProvider]
    UAMP --> AMIP[aiManagementInitializedProvider]
    UAMP --> AMEVP[aiManagementEventProvider]
    UAMP --> PSP2[providerStatsProvider]
    UAMP --> ASP[assistantStatsProvider]

    %% è®¾ç½®ç®¡ç†å±‚
    SRP --> SNP[settingsNotifierProvider]
    SNP --> SVP[settingValueProvider]
    SNP --> DCMP[defaultChatModelProvider]
    SNP --> DTMP[defaultTitleModelProvider]
    SNP --> DTRAP[defaultTranslationModelProvider]
    SNP --> DSMP[defaultSummaryModelProvider]

    %% å¤šåª’ä½“è®¾ç½®
    SNP --> MSP[multimediaSettingsProvider]
    MSP --> MCP2[multimediaCapabilityProvider]

    %% ä¸»é¢˜ç®¡ç†
    SNP --> TNP[themeNotifierProvider]

    %% MCPæœåŠ¡å±‚
    SNP --> MCPSM[mcpServiceManagerProvider]
    SNP --> MCPSP[mcpServiceProvider]
    MCPSM --> MCPSP
    MCPSP --> MCPSS[mcpServerStatusProvider]
    MCPSP --> MCPSE[mcpServerErrorProvider]
    MCPSP --> MCPST[mcpServerToolsProvider]
    MCPSP --> MCPAT[mcpAllToolsProvider]

    %% ç»Ÿä¸€èŠå¤©çŠ¶æ€å±‚ - æ ¸å¿ƒèŠå¤©ç®¡ç†
    UAMP --> UCP[unifiedChatProvider]
    CRP --> UCP
    PSP --> UCP
    MRP --> UCP

    %% èŠå¤©çŠ¶æ€è¡ç”ŸProvider (18ä¸ª)
    UCP --> CCP[currentConversationProvider]
    UCP --> CMP[chatMessagesProvider]
    UCP --> CCFGP[currentChatConfigurationProvider]
    UCP --> CLSP[chatLoadingStateProvider]
    UCP --> CEPV[chatErrorProvider]
    UCP --> CRSP[chatReadyStateProvider]
    UCP --> SMP[streamingMessagesProvider]
    UCP --> HSMP[hasStreamingMessagesProvider]
    UCP --> MCP3[messageCountProvider]
    UCP --> CEP[chatEventProvider]
    UCP --> COP[chatOrchestratorProvider]

    %% èŠå¤©é…ç½®ç®¡ç†
    UAMP --> CCNP[chatConfigurationNotifierProvider]
    PSP --> CCNP

    %% æœç´¢åŠŸèƒ½å±‚
    CRP --> SQP[searchQueryProvider]
    CRP --> STP[searchTypeProvider]
    SQP --> SRPV[searchResultsProvider]
    STP --> SRPV
    CRP --> SRPV

    %% æ”¶è—æ¨¡å‹ç®¡ç†
    FRP --> FMN[favoriteModelNotifierProvider]

    %% å¯¹è¯æ ‡é¢˜ç®¡ç†
    CRP --> CTN[conversationTitleNotifierProvider]

    %% é…ç½®æŒä¹…åŒ–
    PSP --> CPN[configurationPersistenceNotifierProvider]

    %% æµå¼æ¶ˆæ¯å¤„ç†Provider (3ä¸ª)
    MRP --> SMSP[streamingMessageServiceProvider]
    SMSP --> SMUSP[streamingMessageUpdateStreamProvider]
    MISP --> MIMP[messageIdManagerProvider]
    MIMP --> ASMIIP[activeStreamingMessageIdsProvider]

    %% UIæ ·å¼ç®¡ç†Provider (3ä¸ª)
    PSP --> CSP[chatStyleProvider]
    CSP --> CCSP[currentChatStyleProvider]

    %% èŠå¤©çŠ¶æ€æ‘˜è¦
    UCP --> CSSP[chatStatusSummaryProvider]

    %% åº”ç”¨åˆå§‹åŒ–å±‚ - åè°ƒæ‰€æœ‰æœåŠ¡
    DBP --> AIP[appInitializationProvider]
    PSP --> AIP
    UAMP --> AIP
    MCPSM --> AIP
    UCP --> AIP
    SNP --> AIP
    FMN --> AIP

    %% æ•°æ®åˆå§‹åŒ–
    DBP --> IDDP[initializeDefaultDataProvider]

    %% æ ·å¼å®šä¹‰
    classDef service fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef repository fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef unifiedAi fill:#e8f5e8,stroke:#1b5e20,stroke-width:3px
    classDef unifiedChat fill:#fff3e0,stroke:#e65100,stroke-width:3px
    classDef mcpService fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    classDef settings fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef derived fill:#e3f2fd,stroke:#0d47a1,stroke-width:1px
    classDef initialization fill:#fff8e1,stroke:#f57f17,stroke-width:2px
    classDef search fill:#f9fbe7,stroke:#827717,stroke-width:2px
    classDef other fill:#fafafa,stroke:#616161,stroke-width:1px

    %% åº”ç”¨æ ·å¼
    class DB,DBP,PS,PSP,LS,LSP,CEH,CEHP,MSS,MSSP,MIS,MISP service
    class PRP,ARP,FRP,CRP,SRP,MRP repository
    class UAMP,AIPP,EAPP,CAPP,FAPP,AIAP,EAAP,FAAP,AICP,SAP,SPP,SMDP,AMLP,AMEP,AMIP,AMEVP,PSP2,ASP unifiedAi
    class UCP,CCP,CMP,CCFGP,CLSP,CEPV,CRSP,SMP,HSMP,MCP3,CEP,COP,CCNP,CSSP unifiedChat
    class MCPSM,MCPSP,MCPSS,MCPSE,MCPST,MCPAT mcpService
    class SNP,SVP,DCMP,DTMP,DTRAP,DSMP,MSP,MCP2,TNP settings
    class SQP,STP,SRPV search
    class AIP,IDDP initialization
    class SMSP,SMUSP,MIMP,ASMIIP derived
    class CSP,CCSP derived
    class FMN,CTN,CPN other
```

### æ ¸å¿ƒä¾èµ–é“¾

```text
DatabaseService â†’ databaseProvider
    â†“
Repositoryå±‚ (6ä¸ªRepository)
    â†“
ç»Ÿä¸€AIç®¡ç†Provider â†’ AIç›¸å…³è¡ç”ŸProvider (17ä¸ª)
    â†“
ç»Ÿä¸€èŠå¤©Provider â†’ èŠå¤©ç›¸å…³è¡ç”ŸProvider (18ä¸ª)
    â†“
UIç»„ä»¶ â†’ ç”¨æˆ·ç•Œé¢
```

### è·¨æ¨¡å—ä¾èµ–

- **AIç®¡ç†** â† **èŠå¤©çŠ¶æ€** (åŠ©æ‰‹ã€æä¾›å•†ã€æ¨¡å‹é€‰æ‹©)
- **è®¾ç½®ç®¡ç†** â† **å¤šåª’ä½“è®¾ç½®** (åŠŸèƒ½å¼€å…³é…ç½®)
- **MCPæœåŠ¡** â† **èŠå¤©ç¼–æ’** (å·¥å…·è°ƒç”¨é›†æˆ)
- **æœç´¢åŠŸèƒ½** â† **å¯¹è¯ç®¡ç†** (æ¶ˆæ¯å’Œå¯¹è¯æœç´¢)

## ï¿½ æ–‡ä»¶çº§åˆ«ä¾èµ–åˆ†æ

### 1. åŸºç¡€æœåŠ¡å±‚æ–‡ä»¶

#### `lib/shared/presentation/providers/dependency_providers.dart`
**ä¾èµ–å…³ç³»**: æ— å¤–éƒ¨Providerä¾èµ–ï¼Œä½œä¸ºä¾èµ–æ³¨å…¥çš„æ ¹èŠ‚ç‚¹
**æä¾›çš„Provider**:
- `databaseProvider` (ç¬¬33-35è¡Œ) - æ•°æ®åº“å®ä¾‹
- `preferenceServiceProvider` (ç¬¬41-43è¡Œ) - åå¥½è®¾ç½®æœåŠ¡
- `loggerServiceProvider` (ç¬¬49-51è¡Œ) - æ—¥å¿—æœåŠ¡
- `chatErrorHandlerProvider` (ç¬¬56-58è¡Œ) - èŠå¤©é”™è¯¯å¤„ç†
- `providerRepositoryProvider` (ç¬¬64-67è¡Œ) - ä¾èµ– `databaseProvider`
- `assistantRepositoryProvider` (ç¬¬72-75è¡Œ) - ä¾èµ– `databaseProvider`
- `favoriteModelRepositoryProvider` (ç¬¬80-84è¡Œ) - ä¾èµ– `databaseProvider`
- `conversationRepositoryProvider` (ç¬¬89-93è¡Œ) - ä¾èµ– `databaseProvider` + `messageRepositoryProvider`
- `settingRepositoryProvider` (ç¬¬98-101è¡Œ) - ä¾èµ– `databaseProvider`
- `messageRepositoryProvider` (ç¬¬106-109è¡Œ) - ä¾èµ– `databaseProvider`
- `mediaStorageServiceProvider` (ç¬¬114-116è¡Œ) - æ— ä¾èµ–
- `messageIdServiceProvider` (ç¬¬121-123è¡Œ) - æ— ä¾èµ–

### 2. ç»Ÿä¸€AIç®¡ç†å±‚æ–‡ä»¶

#### `lib/features/ai_management/presentation/providers/unified_ai_management_notifier.dart`
**ä¾èµ–å…³ç³»**:
- `providerRepositoryProvider` (ç¬¬27-28è¡Œ)
- `assistantRepositoryProvider` (ç¬¬29-30è¡Œ)
- `preferenceServiceProvider` (ç¬¬31-32è¡Œ)

**æ ¸å¿ƒæ–¹æ³•**:
- `_initialize()` (ç¬¬38-85è¡Œ) - åˆå§‹åŒ–AIç®¡ç†å™¨
- `_loadUserProviders()` (ç¬¬88-97è¡Œ) - åŠ è½½ç”¨æˆ·æä¾›å•†
- `addCustomProvider()` (ç¬¬142-170è¡Œ) - æ·»åŠ è‡ªå®šä¹‰æä¾›å•†

#### `lib/features/ai_management/presentation/providers/unified_ai_management_providers.dart`
**ä¾èµ–å…³ç³»**:
- `unifiedAiManagementProvider` (ç¬¬15-18è¡Œ) - æ ¸å¿ƒçŠ¶æ€Provider

**è¡ç”ŸProvider** (17ä¸ª):
- AIæä¾›å•†ç›¸å…³: `aiProvidersProvider` (ç¬¬21-23è¡Œ), `enabledAiProvidersProvider` (ç¬¬25-27è¡Œ)
- AIåŠ©æ‰‹ç›¸å…³: `aiAssistantsProvider` (ç¬¬38-40è¡Œ), `enabledAiAssistantsProvider` (ç¬¬42-44è¡Œ)
- é…ç½®ç›¸å…³: `aiConfigurationProvider` (ç¬¬51-53è¡Œ), `selectedAssistantProvider` (ç¬¬61-63è¡Œ)
- çŠ¶æ€ç›¸å…³: `aiManagementLoadingProvider` (ç¬¬74-76è¡Œ), `aiManagementErrorProvider` (ç¬¬78-80è¡Œ)

### 3. ç»Ÿä¸€èŠå¤©çŠ¶æ€å±‚æ–‡ä»¶

#### `lib/features/chat/presentation/providers/unified_chat_notifier.dart`
**ä¾èµ–å…³ç³»**:
- `messageRepositoryProvider` (ç¬¬66-67è¡Œ)
- `preferenceServiceProvider` (ç¬¬99-100è¡Œ)
- `unifiedAiManagementProvider` (ç¬¬24è¡Œå¯¼å…¥)

**æ ¸å¿ƒæ–¹æ³•**:
- `_initialize()` (ç¬¬48è¡Œ) - åˆå§‹åŒ–èŠå¤©çŠ¶æ€
- `sendMessage()` - å‘é€æ¶ˆæ¯
- `_processStreamingUpdate()` (ç¬¬1149-1178è¡Œ) - å¤„ç†æµå¼æ›´æ–°

**è¡ç”ŸProvider** (18ä¸ª):
- `currentConversationProvider` (ç¬¬1847-1850è¡Œ)
- `chatMessagesProvider` (ç¬¬1853-1856è¡Œ)
- `chatLoadingStateProvider` (ç¬¬1864-1866è¡Œ)
- `streamingMessagesProvider` (ç¬¬1879-1882è¡Œ)
- `chatEventProvider` (ç¬¬1897-1900è¡Œ)

### 4. è®¾ç½®ç®¡ç†å±‚æ–‡ä»¶

#### `lib/features/settings/presentation/providers/settings_notifier.dart`
**ä¾èµ–å…³ç³»**:
- `settingRepositoryProvider` (ç¬¬60è¡Œ)

**æ ¸å¿ƒæ–¹æ³•**:
- `_initialize()` (ç¬¬63-70è¡Œ) - åˆå§‹åŒ–è®¾ç½®
- `setSetting()` (ç¬¬95-100è¡Œ) - è®¾ç½®å€¼
- `setDefaultChatModel()` (ç¬¬200-207è¡Œ) - è®¾ç½®é»˜è®¤èŠå¤©æ¨¡å‹

**è¡ç”ŸProvider**:
- `settingValueProvider` (ç¬¬388-392è¡Œ)
- `defaultChatModelProvider` (ç¬¬395-401è¡Œ)
- `defaultTitleModelProvider` (ç¬¬403-409è¡Œ)

#### `lib/features/settings/presentation/providers/multimedia_settings_notifier.dart`
**ä¾èµ–å…³ç³»**:
- `settingRepositoryProvider` (ç¬¬40è¡Œ)
- `settingsNotifierProvider` (ç¬¬63è¡Œ) - ç›‘å¬åŸºç¡€è®¾ç½®å˜åŒ–

**æ ¸å¿ƒæ–¹æ³•**:
- `_initialize()` (ç¬¬43-58è¡Œ) - åˆå§‹åŒ–å¤šåª’ä½“è®¾ç½®
- `_setupListeners()` (ç¬¬61-66è¡Œ) - è®¾ç½®ç›‘å¬å™¨

### 5. MCPæœåŠ¡å±‚æ–‡ä»¶

#### `lib/features/settings/presentation/providers/mcp_service_provider.dart`
**ä¾èµ–å…³ç³»**:
- `settingsNotifierProvider` (ç¬¬63-64è¡Œ)
- `mcpServiceManagerProvider` (ç¬¬67è¡Œ)

**æ ¸å¿ƒæ–¹æ³•**:
- `_init()` (ç¬¬73-94è¡Œ) - åˆå§‹åŒ–MCPæœåŠ¡
- `_loadInitialState()` (ç¬¬97-139è¡Œ) - åŠ è½½åˆå§‹çŠ¶æ€
- `setEnabled()` (ç¬¬148-177è¡Œ) - è®¾ç½®MCPå¯ç”¨çŠ¶æ€
- `_updateServerStatuses()` (ç¬¬329-381è¡Œ) - æ›´æ–°æœåŠ¡å™¨çŠ¶æ€

**è¡ç”ŸProvider**:
- `mcpServerStatusProvider` (ç¬¬423-427è¡Œ)
- `mcpServerErrorProvider` (ç¬¬430-434è¡Œ)
- `mcpServerToolsProvider` (ç¬¬437-441è¡Œ)
- `mcpAllToolsProvider` (ç¬¬444-448è¡Œ)

### 6. æœç´¢åŠŸèƒ½å±‚æ–‡ä»¶

#### `lib/features/chat/presentation/providers/chat_search_providers.dart`
**ä¾èµ–å…³ç³»**:
- `conversationRepositoryProvider` (ç¬¬213, 233è¡Œ)

**æ ¸å¿ƒProvider**:
- `searchQueryProvider` (ç¬¬8è¡Œ) - æœç´¢æŸ¥è¯¢çŠ¶æ€
- `searchTypeProvider` (ç¬¬14-15è¡Œ) - æœç´¢ç±»å‹é€‰æ‹©
- `searchResultsProvider` (ç¬¬18-21è¡Œ) - æœç´¢ç»“æœç®¡ç†

**æ ¸å¿ƒæ–¹æ³•**:
- `build()` (ç¬¬111-150è¡Œ) - æ„å»ºæœç´¢ç»“æœ
- `_performSearch()` (ç¬¬208-257è¡Œ) - æ‰§è¡Œæœç´¢
- `loadMore()` (ç¬¬155-187è¡Œ) - åŠ è½½æ›´å¤šç»“æœ

### 7. åº”ç”¨åˆå§‹åŒ–å±‚æ–‡ä»¶

#### `lib/shared/presentation/providers/app_initialization_provider.dart`
**ä¾èµ–å…³ç³»**:
- `databaseProvider` (ç¬¬269è¡Œ)
- `preferenceServiceProvider` (ç¬¬269è¡Œ)
- `unifiedAiManagementProvider` (ç¬¬275è¡Œ)
- `mcpServiceManagerProvider` (ç¬¬269è¡Œ)
- `settingsNotifierProvider` (ç¬¬287è¡Œ)
- `favoriteModelNotifierProvider` (ç¬¬288è¡Œ)

**æ ¸å¿ƒæ–¹æ³•**:
- `_initialize()` (ç¬¬154-185è¡Œ) - å¼€å§‹åˆå§‹åŒ–è¿‡ç¨‹
- `_initializeBasicServices()` (ç¬¬195-222è¡Œ) - åˆå§‹åŒ–åŸºç¡€æœåŠ¡
- `_initializeData()` (ç¬¬266-289è¡Œ) - åˆå§‹åŒ–æ•°æ®

### 8. å…¶ä»–åŠŸèƒ½æ–‡ä»¶

#### `lib/shared/presentation/providers/favorite_model_notifier.dart`
**ä¾èµ–å…³ç³»**:
- `favoriteModelRepositoryProvider` (ç¬¬40-41è¡Œ)

**æ ¸å¿ƒæ–¹æ³•**:
- `addFavoriteModel()` (ç¬¬77-113è¡Œ) - æ·»åŠ æ”¶è—æ¨¡å‹
- `toggleFavoriteModel()` (ç¬¬144-156è¡Œ) - åˆ‡æ¢æ”¶è—çŠ¶æ€

#### `lib/shared/presentation/providers/conversation_title_notifier.dart`
**ä¾èµ–å…³ç³»**:
- `conversationRepositoryProvider` (é€šè¿‡ref.readè°ƒç”¨)

**æ ¸å¿ƒæ–¹æ³•**:
- `generateTitle()` (ç¬¬107-139è¡Œ) - ç”Ÿæˆå¯¹è¯æ ‡é¢˜
- `_generateTitleWithSimpleChat()` (ç¬¬154-180è¡Œ) - ä½¿ç”¨ç®€å•èŠå¤©ç”Ÿæˆæ ‡é¢˜

### 9. æµå¼æ¶ˆæ¯å¤„ç†å±‚æ–‡ä»¶ â­ æ–°å¢

#### `lib/features/chat/presentation/providers/streaming_message_provider.dart`
**ä¾èµ–å…³ç³»**:
- `messageRepositoryProvider` (ç¬¬9è¡Œ)

**æä¾›çš„Provider**:
- `streamingMessageServiceProvider` (ç¬¬7-11è¡Œ) - æµå¼æ¶ˆæ¯æœåŠ¡
- `streamingMessageUpdateStreamProvider` (ç¬¬14-18è¡Œ) - æµå¼æ¶ˆæ¯æ›´æ–°æµ

#### `lib/features/chat/presentation/providers/message_id_manager_provider.dart`
**ä¾èµ–å…³ç³»**:
- `messageIdServiceProvider` (ç¬¬9è¡Œ)

**æä¾›çš„Provider**:
- `messageIdManagerProvider` (ç¬¬8-11è¡Œ) - æ¶ˆæ¯IDç®¡ç†å™¨
- `activeStreamingMessageIdsProvider` (ç¬¬16-19è¡Œ) - æ´»è·ƒæµå¼æ¶ˆæ¯IDåˆ—è¡¨

### 10. UIæ ·å¼ç®¡ç†å±‚æ–‡ä»¶ â­ æ–°å¢

#### `lib/features/chat/presentation/providers/chat_style_provider.dart`
**ä¾èµ–å…³ç³»**:
- `preferenceServiceProvider` (ç¬¬23è¡Œå¯¼å…¥)
- `loggerServiceProvider` (ç¬¬24è¡Œå¯¼å…¥)

**æ ¸å¿ƒæ–¹æ³•**:
- `_loadStyle()` (ç¬¬78-92è¡Œ) - åŠ è½½æ ·å¼è®¾ç½®
- `updateStyle()` (ç¬¬95-114è¡Œ) - æ›´æ–°èŠå¤©æ ·å¼
- `reload()` (ç¬¬117-119è¡Œ) - é‡æ–°åŠ è½½æ ·å¼

**æä¾›çš„Provider**:
- `chatStyleProvider` (ç¬¬123-126è¡Œ) - èŠå¤©æ ·å¼ç®¡ç†
- `currentChatStyleProvider` (ç¬¬129-131è¡Œ) - å½“å‰èŠå¤©æ ·å¼

### 11. èŠå¤©çŠ¶æ€æ‘˜è¦å±‚æ–‡ä»¶ â­ æ–°å¢

#### `lib/features/chat/presentation/providers/chat_status_summary_provider.dart`
**ä¾èµ–å…³ç³»**:
- `unifiedChatProvider` (ç¬¬12è¡Œ)

**æ ¸å¿ƒåŠŸèƒ½**:
- ç»Ÿä¸€ç®¡ç†èŠå¤©ç›¸å…³çš„æ‰€æœ‰çŠ¶æ€ä¿¡æ¯
- èšåˆåŠ è½½ã€é”™è¯¯ã€æµå¼æ¶ˆæ¯ç­‰çŠ¶æ€
- æä¾›ç»Ÿä¸€çš„çŠ¶æ€æ‘˜è¦æ¥å£

**æä¾›çš„Provider**:
- `chatStatusSummaryProvider` (ç¬¬11-28è¡Œ) - èŠå¤©çŠ¶æ€æ‘˜è¦

## ï¿½ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. ç»†ç²’åº¦ç›‘å¬

```dart
// âœ… æ­£ç¡®ï¼šåªç›‘å¬éœ€è¦çš„çŠ¶æ€ç‰‡æ®µ
final isLoading = ref.watch(unifiedChatProvider.select((state) => state.isLoading));

// âŒ é”™è¯¯ï¼šç›‘å¬æ•´ä¸ªçŠ¶æ€å¯¹è±¡
final chatState = ref.watch(unifiedChatProvider);
final isLoading = chatState.isLoading;
```

### 2. autoDisposeä½¿ç”¨

```dart
// âœ… æ­£ç¡®ï¼šä¸´æ—¶Providerä½¿ç”¨autoDispose
final searchQueryProvider = StateProvider.autoDispose<String>((ref) => '');

// âœ… æ­£ç¡®ï¼šfamily Providerä½¿ç”¨autoDispose
final conversationMessagesProvider = Provider.autoDispose.family<List<Message>, String>((ref, conversationId) {
  return ref.watch(blockMessageProvider(conversationId)).messages;
});
```

### 3. æ‰¹é‡çŠ¶æ€æ›´æ–°

```dart
// ä½¿ç”¨æ‰¹é‡æ›´æ–°å™¨å‡å°‘é‡å»ºæ¬¡æ•°
final batch.BatchStateUpdater _batchUpdater = batch.GlobalBatchUpdater.instance;
```

## ğŸ“ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„Provider

1. **ç¡®å®šProviderç±»å‹**
   - `Provider` - åªè¯»æ•°æ®
   - `StateProvider` - ç®€å•çŠ¶æ€
   - `StateNotifierProvider` - å¤æ‚çŠ¶æ€é€»è¾‘
   - `AsyncNotifierProvider` - å¼‚æ­¥æ•°æ®

2. **éµå¾ªå‘½åè§„èŒƒ**
   - æ ¸å¿ƒProvider: `xxxProvider`
   - çŠ¶æ€ç®¡ç†å™¨: `xxxNotifierProvider`
   - ä¾¿æ·è®¿é—®: `xxxStateProvider`
   - å®¶æ—Provider: `xxxProvider.family`

3. **è€ƒè™‘ç”Ÿå‘½å‘¨æœŸ**
   - å…¨å±€çŠ¶æ€: ä¸ä½¿ç”¨autoDispose
   - ä¸´æ—¶çŠ¶æ€: ä½¿ç”¨autoDispose
   - é¡µé¢çº§çŠ¶æ€: ä½¿ç”¨autoDispose

### é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

```dart
// Repositoryå±‚é”™è¯¯å¤„ç†
class ConversationRepository {
  Future<List<Conversation>> getAll() async {
    try {
      final result = await _database.conversations.select().get();
      return result.map((row) => Conversation.fromRow(row)).toList();
    } catch (e) {
      _logger.error('è·å–å¯¹è¯åˆ—è¡¨å¤±è´¥', {'error': e.toString()});
      throw RepositoryException('è·å–å¯¹è¯åˆ—è¡¨å¤±è´¥: $e');
    }
  }
}
```

## ğŸ”® æœªæ¥æ‰©å±•è®¡åˆ’

### 1. Provideråˆå¹¶ä¼˜åŒ–

- å°†ç›¸å…³Provideråˆå¹¶ä¸ºèšåˆProvider
- ä¿æŒå‘åå…¼å®¹çš„è®¿é—®å™¨
- ä½¿ç”¨Freezedåˆ›å»ºç»Ÿä¸€çŠ¶æ€æ¨¡å‹

### 2. æ€§èƒ½ç›‘æ§é›†æˆ

- æ·»åŠ æ€§èƒ½æŒ‡æ ‡æ”¶é›†Provider
- å®æ—¶ç›‘æ§çŠ¶æ€æ›´æ–°é¢‘ç‡
- å†…å­˜ä½¿ç”¨æƒ…å†µè·Ÿè¸ª

### 3. æ’ä»¶ç³»ç»Ÿæ‰©å±•

- æ”¯æŒç¬¬ä¸‰æ–¹Provideræ’ä»¶
- åŠ¨æ€åŠ è½½å’Œå¸è½½Provider
- æ’ä»¶é—´çŠ¶æ€å…±äº«æœºåˆ¶

## ğŸ” é—æ¼æ£€æŸ¥æ€»ç»“ â­ æœ€ç»ˆè¡¥å……

### âœ… å·²è¡¥å……çš„é‡è¦Provider

#### 1. æµå¼æ¶ˆæ¯å¤„ç†ç³»ç»Ÿ (3ä¸ª)
- **`streamingMessageServiceProvider`** - ä¸“é—¨çš„æµå¼æ¶ˆæ¯æœåŠ¡ç®¡ç†
- **`streamingMessageUpdateStreamProvider`** - å®æ—¶æµå¼æ›´æ–°ç›‘å¬
- **`messageIdManagerProvider`** + **`activeStreamingMessageIdsProvider`** - æ¶ˆæ¯IDç”Ÿå‘½å‘¨æœŸç®¡ç†

#### 2. UIæ ·å¼ç®¡ç†ç³»ç»Ÿ (2ä¸ª)
- **`chatStyleProvider`** - èŠå¤©æ°”æ³¡æ ·å¼åŠ¨æ€åˆ‡æ¢
- **`currentChatStyleProvider`** - å½“å‰æ ·å¼çŠ¶æ€è®¿é—®

#### 3. å¢å¼ºçš„åŸºç¡€æœåŠ¡ (4ä¸ª)
- **`mediaStorageServiceProvider`** - å¤šåª’ä½“å­˜å‚¨æœåŠ¡
- **`messageIdServiceProvider`** - æ¶ˆæ¯IDç”ŸæˆæœåŠ¡
- **`chatErrorHandlerProvider`** - èŠå¤©é”™è¯¯å¤„ç†æœåŠ¡
- **`loggerServiceProvider`** - æ—¥å¿—è®°å½•æœåŠ¡

#### 4. èŠå¤©çŠ¶æ€æ‘˜è¦ (1ä¸ª)
- **`chatStatusSummaryProvider`** - ç»Ÿä¸€çš„èŠå¤©çŠ¶æ€æ‘˜è¦

### ğŸ“Š æœ€ç»ˆç»Ÿè®¡

| åˆ†æé˜¶æ®µ | Provideræ•°é‡ | æ–°å‘ç° |
|----------|-------------|--------|
| **åˆå§‹åˆ†æ** | 71ä¸ª | - |
| **æ·±åº¦åˆ†æ** | 81ä¸ª | +10ä¸ª |
| **å®Œæ•´æ€§æ£€æŸ¥** | **81ä¸ª** | **ç¡®è®¤å®Œæ•´** |

### ğŸ¯ æ¶æ„å®Œæ•´æ€§ç¡®è®¤

ç»è¿‡é€æ–‡ä»¶è¯¦ç»†åˆ†æï¼Œyumchaé¡¹ç›®çš„RiverpodçŠ¶æ€ç®¡ç†æ¶æ„å·²ç»è¾¾åˆ°ï¼š

- âœ… **åŠŸèƒ½å®Œæ•´æ€§** - è¦†ç›–æ‰€æœ‰AIèŠå¤©åŠŸèƒ½
- âœ… **ä¾èµ–æ¸…æ™°æ€§** - å®Œæ•´çš„ä¾èµ–å…³ç³»å›¾
- âœ… **æ€§èƒ½ä¼˜åŒ–** - æµå¼å¤„ç†ã€å†…å­˜ç®¡ç†ã€å¹¶å‘æ§åˆ¶
- âœ… **ç”¨æˆ·ä½“éªŒ** - æ ·å¼ç®¡ç†ã€é”™è¯¯å¤„ç†ã€çŠ¶æ€æ‘˜è¦
- âœ… **å¯ç»´æŠ¤æ€§** - åˆ†å±‚æ¶æ„ã€å•ä¸€èŒè´£ã€ä¾èµ–æ³¨å…¥

### ğŸš€ æŠ€æœ¯äº®ç‚¹

1. **ä¸–ç•Œçº§æµå¼å¤„ç†** - å®Œæ•´çš„æµå¼æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
2. **æ™ºèƒ½çŠ¶æ€èšåˆ** - ç»Ÿä¸€çš„çŠ¶æ€æ‘˜è¦å’Œç›‘æ§ç³»ç»Ÿ
3. **å“åº”å¼UIç®¡ç†** - åŠ¨æ€æ ·å¼åˆ‡æ¢å’Œç”¨æˆ·åå¥½æŒä¹…åŒ–
4. **ä¼ä¸šçº§é”™è¯¯å¤„ç†** - åˆ†å±‚é”™è¯¯å¤„ç†å’Œè‡ªåŠ¨æ¢å¤æœºåˆ¶
5. **é«˜æ€§èƒ½æ¶æ„** - å¹¶å‘æ§åˆ¶ã€å†…å­˜ä¼˜åŒ–ã€æ™ºèƒ½ç¼“å­˜

---

*æœ¬æ–‡æ¡£åŸºäºyumchaé¡¹ç›®å½“å‰ä»£ç çŠ¶æ€åˆ†æï¼Œå±•ç¤ºäº†å®Œæ•´çš„AIèŠå¤©RiverpodçŠ¶æ€ç®¡ç†æ¶æ„ã€‚ç»è¿‡æ·±åº¦åˆ†æç¡®è®¤æ¶æ„å®Œæ•´æ€§ã€‚æ–‡æ¡£ç‰ˆæœ¬ï¼š2024å¹´12æœˆ*
