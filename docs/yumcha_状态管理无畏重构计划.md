# ğŸš€ YumCha çŠ¶æ€ç®¡ç†æ— ç•é‡æ„è®¡åˆ’

## ğŸ“‹ æ¦‚è¿°

åŸºäºå½“å‰yumchaé¡¹ç›®å­˜åœ¨çš„é‡å¤è¯·æ±‚ã€å·¥å…·è°ƒç”¨é”™è¯¯ã€æ¶ˆæ¯ä¸å®Œæ•´ç­‰é—®é¢˜ï¼Œä»¥åŠå‚è€ƒCherry Studioçš„æˆç†ŸçŠ¶æ€ç®¡ç†æ¶æ„ï¼Œåˆ¶å®šè¿™ä¸ªæ— ç•é‡æ„è®¡åˆ’ã€‚ç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ªç®€æ´ã€é«˜æ•ˆã€å¯ç»´æŠ¤çš„RiverpodçŠ¶æ€ç®¡ç†æ¶æ„ã€‚

## ğŸ” å½“å‰é—®é¢˜åˆ†æ

### 1. æ ¸å¿ƒé—®é¢˜è¯†åˆ«

#### A. é‡å¤è¯·æ±‚é—®é¢˜ ğŸ”„
- **ç°è±¡**: æ¯ä¸ªHTTPè¯·æ±‚éƒ½è¢«å‘é€äº†ä¸¤æ¬¡
- **æ ¹æœ¬åŸå› **: 
  - äº‹ä»¶ç›‘å¬å™¨è¢«é‡å¤æ³¨å†Œ
  - æµå¼å¤„ç†é€»è¾‘ä¸­å­˜åœ¨é‡å¤è§¦å‘
  - çŠ¶æ€ç®¡ç†å¯¼è‡´çš„é‡å¤æ‰§è¡Œ
- **å½±å“**: æµªè´¹èµ„æºï¼Œå¯èƒ½å¯¼è‡´APIé™åˆ¶

#### B. å·¥å…·è°ƒç”¨æˆåŠŸä½†AIå›ç­”é”™è¯¯ âŒ
- **ç°è±¡**: MCPå·¥å…·æˆåŠŸè¿”å›ç»“æœï¼Œä½†AIæœ€ç»ˆå›ç­”é”™è¯¯
- **æ ¹æœ¬åŸå› **:
  - å·¥å…·ç»“æœæ²¡æœ‰æ­£ç¡®ä¼ é€’ç»™AI
  - æ¶ˆæ¯æ ¼å¼æˆ–ä¸Šä¸‹æ–‡æœ‰é—®é¢˜
  - AIæ¨¡å‹å¿½ç•¥äº†å·¥å…·ç»“æœ
- **å½±å“**: ç”¨æˆ·ä½“éªŒå·®ï¼ŒåŠŸèƒ½ä¸å¯ç”¨

#### C. å›ç­”ä¸å®Œæ•´é—®é¢˜ âš ï¸
- **ç°è±¡**: æµå¼ä¼ è¾“åœ¨35ä¸ªå­—ç¬¦åå°±ç»“æŸ
- **æ ¹æœ¬åŸå› **:
  - æµå¼ä¼ è¾“æå‰ç»“æŸ
  - æ¶ˆæ¯çŠ¶æ€ç®¡ç†é”™è¯¯
  - å†…å®¹æˆªæ–­é€»è¾‘é—®é¢˜
- **å½±å“**: ç”¨æˆ·æ— æ³•è·å¾—å®Œæ•´å›ç­”

#### D. æ¶ˆæ¯é‡å¤é—®é¢˜ ğŸ”
- **ç°è±¡**: ç”¨æˆ·æ¶ˆæ¯åœ¨è¯·æ±‚æ•°æ®ä¸­è¢«é‡å¤
- **æ ¹æœ¬åŸå› **:
  - æ¶ˆæ¯åˆ›å»ºé€»è¾‘é‡å¤æ‰§è¡Œ
  - çŠ¶æ€åŒæ­¥é—®é¢˜
- **å½±å“**: æ··ä¹±çš„å¯¹è¯å†å²

### 2. æ¶æ„å¤æ‚åº¦é—®é¢˜

#### å½“å‰æ¶æ„é—®é¢˜
- **Providerè¿‡å¤š**: 81ä¸ªProviderå¯¼è‡´ä¾èµ–å…³ç³»å¤æ‚
- **èŒè´£ä¸æ¸…**: å¤šä¸ªProviderå¤„ç†ç›¸ä¼¼åŠŸèƒ½
- **çŠ¶æ€åˆ†æ•£**: ç›¸å…³çŠ¶æ€åˆ†å¸ƒåœ¨ä¸åŒProviderä¸­
- **äº‹ä»¶ç³»ç»Ÿå¤æ‚**: äº‹ä»¶å¤„ç†é€»è¾‘åˆ†æ•£ä¸”éš¾ä»¥è°ƒè¯•

## ğŸ¯ é‡æ„ç›®æ ‡

### 1. ç®€åŒ–æ¶æ„
- å°†81ä¸ªProviderç²¾ç®€åˆ°30-40ä¸ªæ ¸å¿ƒProvider
- æ˜ç¡®æ¯ä¸ªProviderçš„å•ä¸€èŒè´£
- å‡å°‘ä¸å¿…è¦çš„ä¾èµ–å…³ç³»

### 2. è§£å†³æ ¸å¿ƒé—®é¢˜
- å½»åº•è§£å†³é‡å¤è¯·æ±‚é—®é¢˜
- ç¡®ä¿å·¥å…·è°ƒç”¨ç»“æœæ­£ç¡®ä¼ é€’
- ä¿è¯æµå¼æ¶ˆæ¯å®Œæ•´æ€§
- æ¶ˆé™¤æ¶ˆæ¯é‡å¤

### 3. æå‡æ€§èƒ½
- ä¼˜åŒ–çŠ¶æ€æ›´æ–°é¢‘ç‡
- å‡å°‘ä¸å¿…è¦çš„é‡å»º
- æ”¹å–„å†…å­˜ä½¿ç”¨

### 4. å¢å¼ºå¯ç»´æŠ¤æ€§
- æ¸…æ™°çš„ä»£ç ç»“æ„
- å®Œå–„çš„é”™è¯¯å¤„ç†
- æ˜“äºæµ‹è¯•å’Œè°ƒè¯•

## ğŸ—ï¸ æ–°æ¶æ„è®¾è®¡

### 1. æ ¸å¿ƒçŠ¶æ€å±‚ (5ä¸ªæ ¸å¿ƒProvider)

#### A. ChatStateProvider - èŠå¤©æ ¸å¿ƒçŠ¶æ€
```dart
final chatStateProvider = StateNotifierProvider<ChatStateNotifier, ChatState>(
  (ref) => ChatStateNotifier(ref),
);
```

**èŒè´£**:
- ç®¡ç†å½“å‰å¯¹è¯
- ç®¡ç†æ¶ˆæ¯åˆ—è¡¨
- å¤„ç†æ¶ˆæ¯å‘é€
- ç®¡ç†èŠå¤©é…ç½®

**Cherry Studioå‚è€ƒ**:
- ğŸ“ `src/renderer/src/store/newMessage.ts` (ç¬¬1-277è¡Œ) - æ¶ˆæ¯çŠ¶æ€ç®¡ç†
- ğŸ“ `src/renderer/src/store/assistants.ts` (ç¬¬83-145è¡Œ) - è¯é¢˜ç®¡ç†
- ğŸ“ `src/renderer/src/store/runtime.ts` (ç¬¬6-14è¡Œ) - èŠå¤©è¿è¡Œæ—¶çŠ¶æ€

**çŠ¶æ€ç»“æ„**:
```dart
@freezed
class ChatState with _$ChatState {
  const factory ChatState({
    @Default(null) Conversation? currentConversation,
    @Default([]) List<Message> messages,
    @Default(ChatStatus.idle) ChatStatus status,
    @Default(null) String? error,
    @Default(ChatConfig()) ChatConfig config,
  }) = _ChatState;
}
```

#### B. StreamingStateProvider - æµå¼æ¶ˆæ¯çŠ¶æ€
```dart
final streamingStateProvider = StateNotifierProvider<StreamingStateNotifier, StreamingState>(
  (ref) => StreamingStateNotifier(ref),
);
```

**èŒè´£**:
- ç®¡ç†æµå¼æ¶ˆæ¯çŠ¶æ€
- å¤„ç†æµå¼å†…å®¹æ›´æ–°
- ç®¡ç†æµå¼æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ

**Cherry Studioå‚è€ƒ**:
- ğŸ“ `src/renderer/src/store/messageBlocks.ts` (ç¬¬1-262è¡Œ) - æ¶ˆæ¯å—æµå¼æ›´æ–°
- ğŸ“ `src/renderer/src/pages/home/Messages/Blocks/index.tsx` (ç¬¬76-161è¡Œ) - æµå¼æ¸²æŸ“

#### C. AssistantStateProvider - åŠ©æ‰‹çŠ¶æ€
```dart
final assistantStateProvider = StateNotifierProvider<AssistantStateNotifier, AssistantState>(
  (ref) => AssistantStateNotifier(ref),
);
```

**èŒè´£**:
- ç®¡ç†åŠ©æ‰‹åˆ—è¡¨
- ç®¡ç†å½“å‰é€‰ä¸­åŠ©æ‰‹
- å¤„ç†åŠ©æ‰‹é…ç½®

**Cherry Studioå‚è€ƒ**:
- ğŸ“ `src/renderer/src/store/assistants.ts` (ç¬¬1-177è¡Œ) - å®Œæ•´åŠ©æ‰‹çŠ¶æ€ç®¡ç†
- ğŸ“ `src/renderer/src/store/assistants.ts` (ç¬¬32-40è¡Œ) - åŠ©æ‰‹CRUDæ“ä½œ
- ğŸ“ `src/renderer/src/store/assistants.ts` (ç¬¬146-155è¡Œ) - åŠ©æ‰‹æ¨¡å‹è®¾ç½®

#### D. ProviderStateProvider - AIæä¾›å•†çŠ¶æ€
```dart
final providerStateProvider = StateNotifierProvider<ProviderStateNotifier, ProviderState>(
  (ref) => ProviderStateNotifier(ref),
);
```

**èŒè´£**:
- ç®¡ç†AIæä¾›å•†åˆ—è¡¨
- ç®¡ç†æä¾›å•†é…ç½®
- å¤„ç†æ¨¡å‹é€‰æ‹©

**Cherry Studioå‚è€ƒ**:
- ğŸ“ `src/renderer/src/store/llm.ts` (ç¬¬1-707è¡Œ) - å®Œæ•´LLMæä¾›å•†ç®¡ç†
- ğŸ“ `src/renderer/src/store/llm.ts` (ç¬¬36-521è¡Œ) - 50+é¢„å®šä¹‰æä¾›å•†
- ğŸ“ `src/renderer/src/store/llm.ts` (ç¬¬597-641è¡Œ) - æä¾›å•†å’Œæ¨¡å‹æ“ä½œ

#### E. AppStateProvider - åº”ç”¨å…¨å±€çŠ¶æ€
```dart
final appStateProvider = StateNotifierProvider<AppStateNotifier, AppState>(
  (ref) => AppStateNotifier(ref),
);
```

**èŒè´£**:
- ç®¡ç†åº”ç”¨åˆå§‹åŒ–çŠ¶æ€
- ç®¡ç†å…¨å±€è®¾ç½®
- å¤„ç†é”™è¯¯çŠ¶æ€

**Cherry Studioå‚è€ƒ**:
- ğŸ“ `src/renderer/src/store/settings.ts` (ç¬¬1-807è¡Œ) - åº”ç”¨è®¾ç½®ç®¡ç†
- ğŸ“ `src/renderer/src/store/index.ts` (ç¬¬49-58è¡Œ) - Redux Persisté…ç½®

### 2. æœåŠ¡å±‚ (8ä¸ªæ ¸å¿ƒæœåŠ¡)

#### A. MessageService - æ¶ˆæ¯æœåŠ¡
- æ¶ˆæ¯CRUDæ“ä½œ
- æ¶ˆæ¯æ ¼å¼åŒ–
- æ¶ˆæ¯éªŒè¯

#### B. StreamingService - æµå¼æœåŠ¡
- æµå¼è¿æ¥ç®¡ç†
- æµå¼å†…å®¹å¤„ç†
- æµå¼çŠ¶æ€åŒæ­¥

#### C. AIService - AIè°ƒç”¨æœåŠ¡
- ç»Ÿä¸€AIè°ƒç”¨æ¥å£
- è¯·æ±‚å»é‡å¤„ç†
- å“åº”æ ¼å¼åŒ–

#### D. ConversationService - å¯¹è¯æœåŠ¡
- å¯¹è¯ç®¡ç†
- å¯¹è¯å†å²
- å¯¹è¯æœç´¢

#### E. DatabaseService - æ•°æ®åº“æœåŠ¡
- æ•°æ®æŒä¹…åŒ–
- æ•°æ®åŒæ­¥
- æ•°æ®è¿ç§»

#### F. ConfigService - é…ç½®æœåŠ¡
- é…ç½®ç®¡ç†
- é…ç½®æŒä¹…åŒ–
- é…ç½®éªŒè¯

#### G. ErrorService - é”™è¯¯å¤„ç†æœåŠ¡
- é”™è¯¯æ”¶é›†
- é”™è¯¯æ¢å¤
- é”™è¯¯æŠ¥å‘Š

#### H. EventService - äº‹ä»¶æœåŠ¡
- äº‹ä»¶åˆ†å‘
- äº‹ä»¶å»é‡
- äº‹ä»¶æ—¥å¿—

### 3. è®¿é—®å±‚ (15-20ä¸ªä¾¿æ·Provider)

åŸºäºæ ¸å¿ƒçŠ¶æ€æä¾›ä¾¿æ·è®¿é—®æ¥å£ï¼Œä½¿ç”¨`Provider`è€Œé`StateNotifierProvider`ï¼š

```dart
// æ¶ˆæ¯ç›¸å…³
final currentMessagesProvider = Provider<List<Message>>((ref) {
  return ref.watch(chatStateProvider.select((state) => state.messages));
});

final streamingMessagesProvider = Provider<List<Message>>((ref) {
  return ref.watch(streamingStateProvider.select((state) => state.activeMessages));
});

// åŠ©æ‰‹ç›¸å…³
final currentAssistantProvider = Provider<Assistant?>((ref) {
  return ref.watch(assistantStateProvider.select((state) => state.currentAssistant));
});

// æä¾›å•†ç›¸å…³
final enabledProvidersProvider = Provider<List<AIProvider>>((ref) {
  return ref.watch(providerStateProvider.select((state) => 
    state.providers.where((p) => p.isEnabled).toList()));
});
```

## ğŸ”§ é‡æ„å®æ–½æ¦‚è¿°

æœ¬é‡æ„å°†åˆ†é˜¶æ®µè¿›è¡Œï¼Œä¼˜å…ˆè§£å†³æ ¸å¿ƒèŠå¤©åŠŸèƒ½çš„é—®é¢˜ï¼Œç„¶åé€æ­¥å®Œå–„å…¶ä»–åŠŸèƒ½ã€‚è¯¦ç»†çš„å®æ–½è®¡åˆ’è¯·å‚è€ƒ [é‡æ„è®¡åˆ’è¯¦æƒ…](./é‡æ„è®¡åˆ’è¯¦æƒ….md)ã€‚

### æ ¸å¿ƒé˜¶æ®µæ¦‚è§ˆ
1. **èŠå¤©æ ¸å¿ƒé‡æ„** - è§£å†³é‡å¤è¯·æ±‚ã€å·¥å…·è°ƒç”¨ã€æµå¼æ¶ˆæ¯ç­‰æ ¸å¿ƒé—®é¢˜
2. **æ¶ˆæ¯ä½“éªŒä¼˜åŒ–** - å®Œå–„æ¶ˆæ¯å—ã€äº¤äº’çŠ¶æ€ã€UIä½“éªŒ
3. **åŠŸèƒ½å®Œå–„** - æ·»åŠ é«˜çº§åŠŸèƒ½å’Œç³»ç»Ÿçº§çŠ¶æ€ç®¡ç†
4. **æ¸…ç†ä¼˜åŒ–** - ä»£ç æ¸…ç†ã€æ€§èƒ½ä¼˜åŒ–ã€æ–‡æ¡£å®Œå–„

## ğŸ“Š é¢„æœŸæ”¶ç›Š

### 1. æ€§èƒ½æå‡
- Provideræ•°é‡å‡å°‘50%ä»¥ä¸Š
- çŠ¶æ€æ›´æ–°é¢‘ç‡é™ä½30%
- å†…å­˜ä½¿ç”¨ä¼˜åŒ–20%

### 2. é—®é¢˜è§£å†³
- å½»åº•è§£å†³é‡å¤è¯·æ±‚é—®é¢˜
- ç¡®ä¿å·¥å…·è°ƒç”¨æ­£ç¡®æ€§
- ä¿è¯æ¶ˆæ¯å®Œæ•´æ€§

### 3. å¯ç»´æŠ¤æ€§æå‡
- ä»£ç å¤æ‚åº¦é™ä½
- è°ƒè¯•éš¾åº¦å‡å°‘
- æ–°åŠŸèƒ½å¼€å‘æ•ˆç‡æå‡

## ğŸš¨ é£é™©è¯„ä¼°

### 1. é«˜é£é™©
- å¤§è§„æ¨¡é‡æ„å¯èƒ½å¼•å…¥æ–°bug
- ç”¨æˆ·æ•°æ®è¿ç§»é£é™©

### 2. ä¸­é£é™©
- å¼€å‘å‘¨æœŸå¯èƒ½å»¶é•¿
- å›¢é˜Ÿå­¦ä¹ æˆæœ¬

### 3. ä½é£é™©
- æ€§èƒ½å¯èƒ½æš‚æ—¶ä¸‹é™
- éƒ¨åˆ†åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨

## ğŸ›¡ï¸ é£é™©ç¼“è§£ç­–ç•¥

1. **åˆ†é˜¶æ®µå®æ–½**: é€æ­¥æ›¿æ¢ï¼Œä¿æŒåŠŸèƒ½å¯ç”¨
2. **å……åˆ†æµ‹è¯•**: æ¯ä¸ªé˜¶æ®µéƒ½è¿›è¡Œå…¨é¢æµ‹è¯•
3. **æ•°æ®å¤‡ä»½**: ç¡®ä¿ç”¨æˆ·æ•°æ®å®‰å…¨
4. **å›æ»šè®¡åˆ’**: å‡†å¤‡å¿«é€Ÿå›æ»šæ–¹æ¡ˆ

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. å›¢é˜Ÿè®¨è®ºå’Œç¡®è®¤é‡æ„è®¡åˆ’
2. åˆ›å»ºè¯¦ç»†çš„æŠ€æœ¯è®¾è®¡æ–‡æ¡£
3. å¼€å§‹ç¬¬ä¸€é˜¶æ®µçš„å®æ–½
4. å»ºç«‹æµ‹è¯•å’Œç›‘æ§ä½“ç³»

## ğŸ”¬ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. æ ¸å¿ƒçŠ¶æ€è®¾è®¡

#### ChatState è¯¦ç»†è®¾è®¡
```dart
@freezed
class ChatState with _$ChatState {
  const factory ChatState({
    // å¯¹è¯ç®¡ç†
    @Default(null) Conversation? currentConversation,
    @Default([]) List<Message> messages,
    @Default({}) Map<String, Message> messageMap, // å¿«é€ŸæŸ¥æ‰¾

    // çŠ¶æ€ç®¡ç†
    @Default(ChatStatus.idle) ChatStatus status,
    @Default(null) String? error,
    @Default(false) bool isLoading,

    // é…ç½®
    @Default(ChatConfig()) ChatConfig config,

    // æ€§èƒ½ä¼˜åŒ–
    @Default(0) int messageCount,
    @Default(null) DateTime? lastUpdateTime,
  }) = _ChatState;
}

enum ChatStatus {
  idle,           // ç©ºé—²
  sending,        // å‘é€ä¸­
  receiving,      // æ¥æ”¶ä¸­
  streaming,      // æµå¼æ¥æ”¶ä¸­
  error,          // é”™è¯¯çŠ¶æ€
}
```

#### StreamingState è¯¦ç»†è®¾è®¡
```dart
@freezed
class StreamingState with _$StreamingState {
  const factory StreamingState({
    // æ´»è·ƒçš„æµå¼æ¶ˆæ¯
    @Default({}) Map<String, StreamingMessage> activeStreams,

    // æµå¼çŠ¶æ€
    @Default(StreamingStatus.idle) StreamingStatus status,
    @Default(null) String? error,

    // æ€§èƒ½ç›‘æ§
    @Default(0) int totalStreams,
    @Default(0) int activeStreamCount,
    @Default(null) DateTime? lastStreamTime,
  }) = _StreamingState;
}

@freezed
class StreamingMessage with _$StreamingMessage {
  const factory StreamingMessage({
    required String messageId,
    required String conversationId,
    @Default('') String content,
    @Default('') String thinking,
    @Default(false) bool isComplete,
    @Default(null) DateTime? startTime,
    @Default(null) DateTime? lastUpdateTime,
  }) = _StreamingMessage;
}
```

### 2. æœåŠ¡å±‚æ¶æ„

#### AIService æ ¸å¿ƒå®ç°
```dart
class AIService {
  final Ref _ref;
  final Map<String, CancelToken> _activeRequests = {};

  AIService(this._ref);

  /// å‘é€æ¶ˆæ¯ - è§£å†³é‡å¤è¯·æ±‚é—®é¢˜
  Future<AIResponse> sendMessage({
    required String content,
    required String conversationId,
    required Assistant assistant,
    required AIProvider provider,
    bool useStreaming = true,
  }) async {
    // ç”Ÿæˆè¯·æ±‚IDï¼Œé˜²æ­¢é‡å¤è¯·æ±‚
    final requestId = _generateRequestId(conversationId, content);

    // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒè¯·æ±‚åœ¨è¿›è¡Œ
    if (_activeRequests.containsKey(requestId)) {
      throw DuplicateRequestException('ç›¸åŒè¯·æ±‚æ­£åœ¨è¿›è¡Œä¸­');
    }

    final cancelToken = CancelToken();
    _activeRequests[requestId] = cancelToken;

    try {
      if (useStreaming) {
        return await _sendStreamingMessage(
          content: content,
          conversationId: conversationId,
          assistant: assistant,
          provider: provider,
          cancelToken: cancelToken,
        );
      } else {
        return await _sendNormalMessage(
          content: content,
          conversationId: conversationId,
          assistant: assistant,
          provider: provider,
          cancelToken: cancelToken,
        );
      }
    } finally {
      _activeRequests.remove(requestId);
    }
  }

  /// ç”Ÿæˆè¯·æ±‚ID
  String _generateRequestId(String conversationId, String content) {
    return '$conversationId:${content.hashCode}:${DateTime.now().millisecondsSinceEpoch}';
  }
}
```

#### StreamingService æ ¸å¿ƒå®ç°
```dart
class StreamingService {
  final Ref _ref;
  final StreamController<StreamingUpdate> _updateController = StreamController.broadcast();

  StreamingService(this._ref);

  /// å¼€å§‹æµå¼å¤„ç†
  Future<void> startStreaming({
    required String messageId,
    required String conversationId,
    required Stream<String> contentStream,
  }) async {
    try {
      // åˆå§‹åŒ–æµå¼æ¶ˆæ¯
      _ref.read(streamingStateProvider.notifier).initializeStream(
        messageId: messageId,
        conversationId: conversationId,
      );

      // å¤„ç†æµå¼å†…å®¹
      await for (final content in contentStream) {
        // æ›´æ–°æµå¼çŠ¶æ€
        _ref.read(streamingStateProvider.notifier).updateStreamContent(
          messageId: messageId,
          content: content,
        );

        // å‘é€æ›´æ–°äº‹ä»¶
        _updateController.add(StreamingUpdate(
          messageId: messageId,
          content: content,
          isComplete: false,
        ));
      }

      // å®Œæˆæµå¼å¤„ç†
      _ref.read(streamingStateProvider.notifier).completeStream(messageId);

    } catch (error) {
      // é”™è¯¯å¤„ç†
      _ref.read(streamingStateProvider.notifier).errorStream(messageId, error.toString());
      rethrow;
    }
  }
}
```

### 3. æ¶ˆæ¯å»é‡ç­–ç•¥

**Cherry Studioå‚è€ƒ**:
- ğŸ“ `src/renderer/src/store/newMessage.ts` (ç¬¬74-239è¡Œ) - æ¶ˆæ¯CRUDæ“ä½œé˜²é‡å¤
- ğŸ“ `src/renderer/src/services/ApiService.ts` - APIè°ƒç”¨å»é‡æœºåˆ¶
- ğŸ“ `src/renderer/src/store/messageBlocks.ts` (ç¬¬32-56è¡Œ) - æ¶ˆæ¯å—æ“ä½œå»é‡

#### è¯·æ±‚å»é‡
```dart
class RequestDeduplicator {
  final Map<String, DateTime> _recentRequests = {};
  final Duration _deduplicationWindow = const Duration(seconds: 2);

  bool shouldAllowRequest(String requestKey) {
    final now = DateTime.now();
    final lastRequest = _recentRequests[requestKey];

    if (lastRequest != null &&
        now.difference(lastRequest) < _deduplicationWindow) {
      return false; // é‡å¤è¯·æ±‚ï¼Œæ‹’ç»
    }

    _recentRequests[requestKey] = now;
    _cleanupOldRequests(now);
    return true;
  }

  void _cleanupOldRequests(DateTime now) {
    _recentRequests.removeWhere((key, time) =>
      now.difference(time) > _deduplicationWindow);
  }
}
```

#### äº‹ä»¶å»é‡
```dart
class EventDeduplicator {
  final Map<String, dynamic> _lastEvents = {};

  bool shouldEmitEvent(ChatEvent event) {
    final eventKey = event.runtimeType.toString();
    final lastEvent = _lastEvents[eventKey];

    // å¯¹äºç›¸åŒç±»å‹çš„äº‹ä»¶ï¼Œæ£€æŸ¥å†…å®¹æ˜¯å¦ç›¸åŒ
    if (lastEvent != null && _eventsEqual(lastEvent, event)) {
      return false; // é‡å¤äº‹ä»¶ï¼Œä¸å‘é€
    }

    _lastEvents[eventKey] = event;
    return true;
  }

  bool _eventsEqual(dynamic event1, dynamic event2) {
    // å®ç°äº‹ä»¶å†…å®¹æ¯”è¾ƒé€»è¾‘
    return event1.toString() == event2.toString();
  }
}
```

### 4. å·¥å…·è°ƒç”¨ä¿®å¤

**Cherry Studioå‚è€ƒ**:
- ğŸ“ `src/renderer/src/pages/home/Messages/Blocks/index.tsx` (ç¬¬131-132è¡Œ) - å·¥å…·è°ƒç”¨å—æ¸²æŸ“
- ğŸ“ `src/renderer/src/store/messageBlocks.ts` (ç¬¬84-253è¡Œ) - å·¥å…·è°ƒç”¨ç»“æœæ ¼å¼åŒ–
- ğŸ“ `src/renderer/src/services/ToolService.ts` - å·¥å…·è°ƒç”¨æœåŠ¡å®ç°

#### å·¥å…·ç»“æœä¼ é€’
```dart
class ToolCallHandler {
  /// å¤„ç†å·¥å…·è°ƒç”¨ç»“æœ
  Future<String> handleToolCall({
    required ToolCall toolCall,
    required Map<String, dynamic> toolResult,
  }) async {
    // ç¡®ä¿å·¥å…·ç»“æœæ­£ç¡®æ ¼å¼åŒ–
    final formattedResult = _formatToolResult(toolResult);

    // åˆ›å»ºå·¥å…·è°ƒç”¨æ¶ˆæ¯å— - å‚è€ƒCherry Studio TOOLå—ç±»å‹
    final toolBlock = MessageBlock.toolCall(
      toolName: toolCall.name,
      toolArgs: toolCall.arguments,
      toolResult: formattedResult,
      timestamp: DateTime.now(),
    );

    // è¿”å›æ ¼å¼åŒ–çš„ç»“æœï¼Œç¡®ä¿AIèƒ½æ­£ç¡®ç†è§£
    return _createToolResultMessage(toolCall, formattedResult);
  }

  String _formatToolResult(Map<String, dynamic> result) {
    // ç¡®ä¿ç»“æœæ ¼å¼æ­£ç¡®ï¼ŒAIèƒ½å¤Ÿç†è§£
    if (result.containsKey('error')) {
      return 'å·¥å…·è°ƒç”¨å¤±è´¥: ${result['error']}';
    }

    if (result.containsKey('result')) {
      return 'å·¥å…·è°ƒç”¨æˆåŠŸ: ${result['result']}';
    }

    return 'å·¥å…·è°ƒç”¨ç»“æœ: ${jsonEncode(result)}';
  }

  String _createToolResultMessage(ToolCall toolCall, String result) {
    return '''
å·¥å…·è°ƒç”¨: ${toolCall.name}
å‚æ•°: ${jsonEncode(toolCall.arguments)}
ç»“æœ: $result

è¯·åŸºäºä»¥ä¸Šå·¥å…·è°ƒç”¨ç»“æœå›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚
''';
  }
}
```

### 5. æµå¼æ¶ˆæ¯å®Œæ•´æ€§ä¿è¯

**Cherry Studioå‚è€ƒ**:
- ğŸ“ `src/renderer/src/store/messageBlocks.ts` (ç¬¬32-56è¡Œ) - æµå¼æ¶ˆæ¯å—æ›´æ–°
- ğŸ“ `src/renderer/src/services/StreamProcessingService.ts` - æµå¼å¤„ç†æœåŠ¡
- ğŸ“ `src/renderer/src/pages/home/Messages/Blocks/index.tsx` (ç¬¬76-161è¡Œ) - æµå¼æ¸²æŸ“ç®¡ç†

#### æµå¼å†…å®¹ç®¡ç†
```dart
class StreamingContentManager {
  final Map<String, StringBuffer> _contentBuffers = {};
  final Map<String, Timer> _timeoutTimers = {};

  /// æ›´æ–°æµå¼å†…å®¹ - å‚è€ƒCherry Studio upsertOneBlock
  void updateContent(String messageId, String contentDelta) {
    // è·å–æˆ–åˆ›å»ºå†…å®¹ç¼“å†²åŒº
    final buffer = _contentBuffers.putIfAbsent(messageId, () => StringBuffer());

    // æ·»åŠ æ–°å†…å®¹
    buffer.write(contentDelta);

    // é‡ç½®è¶…æ—¶å®šæ—¶å™¨
    _resetTimeoutTimer(messageId);

    // é€šçŸ¥UIæ›´æ–°
    _notifyContentUpdate(messageId, buffer.toString());
  }

  /// å®Œæˆæµå¼å†…å®¹
  String completeContent(String messageId) {
    final buffer = _contentBuffers.remove(messageId);
    _timeoutTimers.remove(messageId)?.cancel();

    if (buffer == null) {
      throw StateError('æµå¼æ¶ˆæ¯ä¸å­˜åœ¨: $messageId');
    }

    final finalContent = buffer.toString();

    // éªŒè¯å†…å®¹å®Œæ•´æ€§
    if (finalContent.isEmpty) {
      throw StateError('æµå¼æ¶ˆæ¯å†…å®¹ä¸ºç©º: $messageId');
    }

    return finalContent;
  }

  void _resetTimeoutTimer(String messageId) {
    _timeoutTimers[messageId]?.cancel();
    _timeoutTimers[messageId] = Timer(const Duration(seconds: 30), () {
      // è¶…æ—¶å¤„ç†
      _handleStreamTimeout(messageId);
    });
  }

  void _handleStreamTimeout(String messageId) {
    final buffer = _contentBuffers.remove(messageId);
    if (buffer != null) {
      // å¼ºåˆ¶å®Œæˆæµå¼æ¶ˆæ¯
      final partialContent = buffer.toString();
      _notifyStreamTimeout(messageId, partialContent);
    }
  }
}
```

## ğŸ“‹ å…·ä½“Providerå®ç°ç¤ºä¾‹

### 1. ChatStateNotifier å®ç°

```dart
class ChatStateNotifier extends StateNotifier<ChatState> {
  final Ref _ref;
  final RequestDeduplicator _deduplicator = RequestDeduplicator();

  ChatStateNotifier(this._ref) : super(const ChatState());

  /// å‘é€æ¶ˆæ¯ - è§£å†³é‡å¤è¯·æ±‚é—®é¢˜
  Future<void> sendMessage(String content, {bool useStreaming = true}) async {
    // ç”Ÿæˆè¯·æ±‚é”®ï¼Œé˜²æ­¢é‡å¤
    final requestKey = _generateRequestKey(content);

    if (!_deduplicator.shouldAllowRequest(requestKey)) {
      throw DuplicateRequestException('è¯·æ±‚æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™');
    }

    try {
      // æ›´æ–°çŠ¶æ€ä¸ºå‘é€ä¸­
      state = state.copyWith(status: ChatStatus.sending, error: null);

      // è·å–å½“å‰é…ç½®
      final assistant = _ref.read(currentAssistantProvider);
      final provider = _ref.read(currentProviderProvider);

      if (assistant == null || provider == null) {
        throw StateError('æœªé€‰æ‹©åŠ©æ‰‹æˆ–æä¾›å•†');
      }

      // è°ƒç”¨AIæœåŠ¡
      final response = await _ref.read(aiServiceProvider).sendMessage(
        content: content,
        conversationId: state.currentConversation?.id ?? '',
        assistant: assistant,
        provider: provider,
        useStreaming: useStreaming,
      );

      // å¤„ç†å“åº”
      if (useStreaming) {
        // æµå¼å“åº”ç”±StreamingServiceå¤„ç†
        state = state.copyWith(status: ChatStatus.streaming);
      } else {
        // ç›´æ¥æ·»åŠ æ¶ˆæ¯
        _addMessage(response.message);
        state = state.copyWith(status: ChatStatus.idle);
      }

    } catch (error) {
      state = state.copyWith(
        status: ChatStatus.error,
        error: error.toString(),
      );
      rethrow;
    }
  }

  /// æ·»åŠ æ¶ˆæ¯
  void _addMessage(Message message) {
    final updatedMessages = [...state.messages, message];
    final updatedMessageMap = {...state.messageMap, message.id: message};

    state = state.copyWith(
      messages: updatedMessages,
      messageMap: updatedMessageMap,
      messageCount: updatedMessages.length,
      lastUpdateTime: DateTime.now(),
    );
  }

  String _generateRequestKey(String content) {
    final conversationId = state.currentConversation?.id ?? 'default';
    return '$conversationId:${content.hashCode}';
  }
}
```

### 2. StreamingStateNotifier å®ç°

```dart
class StreamingStateNotifier extends StateNotifier<StreamingState> {
  final Ref _ref;
  final StreamingContentManager _contentManager = StreamingContentManager();

  StreamingStateNotifier(this._ref) : super(const StreamingState());

  /// åˆå§‹åŒ–æµå¼æ¶ˆæ¯
  void initializeStream({
    required String messageId,
    required String conversationId,
  }) {
    final streamingMessage = StreamingMessage(
      messageId: messageId,
      conversationId: conversationId,
      startTime: DateTime.now(),
    );

    final updatedStreams = {...state.activeStreams, messageId: streamingMessage};

    state = state.copyWith(
      activeStreams: updatedStreams,
      activeStreamCount: updatedStreams.length,
      status: StreamingStatus.active,
      lastStreamTime: DateTime.now(),
    );
  }

  /// æ›´æ–°æµå¼å†…å®¹
  void updateStreamContent({
    required String messageId,
    required String content,
    String? thinking,
  }) {
    final existingStream = state.activeStreams[messageId];
    if (existingStream == null) {
      throw StateError('æµå¼æ¶ˆæ¯ä¸å­˜åœ¨: $messageId');
    }

    // ä½¿ç”¨å†…å®¹ç®¡ç†å™¨æ›´æ–°å†…å®¹
    _contentManager.updateContent(messageId, content);

    final updatedStream = existingStream.copyWith(
      content: content,
      thinking: thinking ?? existingStream.thinking,
      lastUpdateTime: DateTime.now(),
    );

    final updatedStreams = {...state.activeStreams, messageId: updatedStream};

    state = state.copyWith(
      activeStreams: updatedStreams,
      lastStreamTime: DateTime.now(),
    );

    // é€šçŸ¥èŠå¤©çŠ¶æ€æ›´æ–°
    _ref.read(chatStateProvider.notifier).updateStreamingMessage(updatedStream);
  }

  /// å®Œæˆæµå¼æ¶ˆæ¯
  void completeStream(String messageId) {
    final stream = state.activeStreams[messageId];
    if (stream == null) return;

    try {
      // è·å–å®Œæ•´å†…å®¹
      final finalContent = _contentManager.completeContent(messageId);

      // åˆ›å»ºæœ€ç»ˆæ¶ˆæ¯
      final finalMessage = Message.ai(
        id: messageId,
        content: finalContent,
        conversationId: stream.conversationId,
        timestamp: DateTime.now(),
        status: MessageStatus.aiSuccess,
      );

      // æ·»åŠ åˆ°èŠå¤©çŠ¶æ€
      _ref.read(chatStateProvider.notifier).addCompletedMessage(finalMessage);

      // ä»æ´»è·ƒæµä¸­ç§»é™¤
      final updatedStreams = {...state.activeStreams}..remove(messageId);

      state = state.copyWith(
        activeStreams: updatedStreams,
        activeStreamCount: updatedStreams.length,
        totalStreams: state.totalStreams + 1,
        status: updatedStreams.isEmpty ? StreamingStatus.idle : StreamingStatus.active,
      );

    } catch (error) {
      errorStream(messageId, error.toString());
    }
  }

  /// æµå¼é”™è¯¯å¤„ç†
  void errorStream(String messageId, String error) {
    final updatedStreams = {...state.activeStreams}..remove(messageId);

    state = state.copyWith(
      activeStreams: updatedStreams,
      activeStreamCount: updatedStreams.length,
      status: StreamingStatus.error,
      error: error,
    );

    // é€šçŸ¥èŠå¤©çŠ¶æ€
    _ref.read(chatStateProvider.notifier).handleStreamingError(messageId, error);
  }
}
```

## ğŸ”„ è¿ç§»æŒ‡å—

### 1. ç°æœ‰ä»£ç è¿ç§»æ­¥éª¤

#### æ­¥éª¤1: åˆ›å»ºæ–°çš„æ ¸å¿ƒProvider
```bash
# åˆ›å»ºæ–°çš„çŠ¶æ€æ–‡ä»¶
mkdir -p lib/core/state
touch lib/core/state/chat_state.dart
touch lib/core/state/streaming_state.dart
touch lib/core/state/assistant_state.dart
touch lib/core/state/provider_state.dart
touch lib/core/state/app_state.dart
```

#### æ­¥éª¤2: å®ç°æ–°çš„çŠ¶æ€ç±»
```dart
// lib/core/state/chat_state.dart
import 'package:freezed_annotation/freezed_annotation.dart';
import '../models/message.dart';
import '../models/conversation.dart';

part 'chat_state.freezed.dart';

@freezed
class ChatState with _$ChatState {
  const factory ChatState({
    @Default(null) Conversation? currentConversation,
    @Default([]) List<Message> messages,
    @Default({}) Map<String, Message> messageMap,
    @Default(ChatStatus.idle) ChatStatus status,
    @Default(null) String? error,
    @Default(false) bool isLoading,
    @Default(ChatConfig()) ChatConfig config,
    @Default(0) int messageCount,
    @Default(null) DateTime? lastUpdateTime,
  }) = _ChatState;
}

enum ChatStatus { idle, sending, receiving, streaming, error }
```

#### æ­¥éª¤3: åˆ›å»ºæ–°çš„Provider
```dart
// lib/core/providers/chat_providers.dart
import 'package:riverpod/riverpod.dart';
import '../state/chat_state.dart';
import '../notifiers/chat_state_notifier.dart';

final chatStateProvider = StateNotifierProvider<ChatStateNotifier, ChatState>(
  (ref) => ChatStateNotifier(ref),
);

// ä¾¿æ·è®¿é—®Provider
final currentMessagesProvider = Provider<List<Message>>((ref) {
  return ref.watch(chatStateProvider.select((state) => state.messages));
});

final chatStatusProvider = Provider<ChatStatus>((ref) {
  return ref.watch(chatStateProvider.select((state) => state.status));
});

final isLoadingProvider = Provider<bool>((ref) {
  return ref.watch(chatStateProvider.select((state) => state.isLoading));
});
```

#### æ­¥éª¤4: æ›´æ–°UIç»„ä»¶
```dart
// æ—§ä»£ç 
class ChatView extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final messages = ref.watch(chatMessagesProvider);
    final isLoading = ref.watch(chatLoadingStateProvider);

    return Column(
      children: [
        Expanded(
          child: MessageList(messages: messages),
        ),
        ChatInput(
          onSend: (content) {
            ref.read(unifiedChatProvider.notifier).sendMessage(content);
          },
        ),
      ],
    );
  }
}

// æ–°ä»£ç 
class ChatView extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final messages = ref.watch(currentMessagesProvider);
    final isLoading = ref.watch(isLoadingProvider);

    return Column(
      children: [
        Expanded(
          child: MessageList(messages: messages),
        ),
        ChatInput(
          onSend: (content) {
            ref.read(chatStateProvider.notifier).sendMessage(content);
          },
        ),
      ],
    );
  }
}
```

### 2. æ•°æ®è¿ç§»ç­–ç•¥

#### æ•°æ®åº“è¿ç§»
```dart
class DatabaseMigration {
  static Future<void> migrateToNewSchema() async {
    final db = await DatabaseService.instance.database;

    // å¤‡ä»½ç°æœ‰æ•°æ®
    await _backupExistingData(db);

    // åˆ›å»ºæ–°è¡¨ç»“æ„
    await _createNewTables(db);

    // è¿ç§»æ•°æ®
    await _migrateData(db);

    // éªŒè¯è¿ç§»ç»“æœ
    await _validateMigration(db);
  }

  static Future<void> _backupExistingData(Database db) async {
    // å¤‡ä»½å…³é”®æ•°æ®åˆ°ä¸´æ—¶è¡¨
    await db.execute('''
      CREATE TABLE IF NOT EXISTS messages_backup AS
      SELECT * FROM messages
    ''');

    await db.execute('''
      CREATE TABLE IF NOT EXISTS conversations_backup AS
      SELECT * FROM conversations
    ''');
  }

  static Future<void> _migrateData(Database db) async {
    // è¿ç§»æ¶ˆæ¯æ•°æ®
    await db.execute('''
      INSERT INTO new_messages (id, content, conversation_id, created_at, status)
      SELECT id, content, conversation_id, created_at, 'success' as status
      FROM messages_backup
    ''');

    // è¿ç§»å¯¹è¯æ•°æ®
    await db.execute('''
      INSERT INTO new_conversations (id, title, created_at, updated_at)
      SELECT id, title, created_at, updated_at
      FROM conversations_backup
    ''');
  }
}
```

### 3. æµ‹è¯•ç­–ç•¥

#### å•å…ƒæµ‹è¯•
```dart
// test/core/state/chat_state_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:riverpod/riverpod.dart';
import 'package:yumcha/core/state/chat_state.dart';
import 'package:yumcha/core/notifiers/chat_state_notifier.dart';

void main() {
  group('ChatStateNotifier', () {
    late ProviderContainer container;

    setUp(() {
      container = ProviderContainer();
    });

    tearDown(() {
      container.dispose();
    });

    test('åˆå§‹çŠ¶æ€åº”è¯¥æ˜¯idle', () {
      final chatState = container.read(chatStateProvider);
      expect(chatState.status, ChatStatus.idle);
      expect(chatState.messages, isEmpty);
    });

    test('å‘é€æ¶ˆæ¯åº”è¯¥æ›´æ–°çŠ¶æ€', () async {
      final notifier = container.read(chatStateProvider.notifier);

      // æ¨¡æ‹Ÿå‘é€æ¶ˆæ¯
      await notifier.sendMessage('Hello');

      final state = container.read(chatStateProvider);
      expect(state.status, ChatStatus.sending);
    });

    test('ä¸åº”è¯¥å…è®¸é‡å¤è¯·æ±‚', () async {
      final notifier = container.read(chatStateProvider.notifier);

      // ç¬¬ä¸€æ¬¡è¯·æ±‚
      final future1 = notifier.sendMessage('Hello');

      // ç«‹å³å‘é€ç›¸åŒè¯·æ±‚
      expect(
        () => notifier.sendMessage('Hello'),
        throwsA(isA<DuplicateRequestException>()),
      );

      await future1;
    });
  });
}
```

#### é›†æˆæµ‹è¯•
```dart
// integration_test/chat_flow_test.dart
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';
import 'package:yumcha/main.dart' as app;

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();

  group('èŠå¤©æµç¨‹æµ‹è¯•', () {
    testWidgets('å®Œæ•´çš„æ¶ˆæ¯å‘é€æµç¨‹', (tester) async {
      app.main();
      await tester.pumpAndSettle();

      // æ‰¾åˆ°è¾“å…¥æ¡†
      final inputField = find.byType(TextField);
      expect(inputField, findsOneWidget);

      // è¾“å…¥æ¶ˆæ¯
      await tester.enterText(inputField, 'Hello, AI!');
      await tester.pumpAndSettle();

      // ç‚¹å‡»å‘é€æŒ‰é’®
      final sendButton = find.byIcon(Icons.send);
      await tester.tap(sendButton);
      await tester.pumpAndSettle();

      // éªŒè¯æ¶ˆæ¯å·²æ·»åŠ 
      expect(find.text('Hello, AI!'), findsOneWidget);

      // ç­‰å¾…AIå“åº”
      await tester.pumpAndSettle(const Duration(seconds: 5));

      // éªŒè¯AIå“åº”å­˜åœ¨
      final messageList = find.byType(ListView);
      expect(messageList, findsOneWidget);
    });

    testWidgets('æµå¼æ¶ˆæ¯æµ‹è¯•', (tester) async {
      app.main();
      await tester.pumpAndSettle();

      // å¯ç”¨æµå¼æ¨¡å¼
      final streamingToggle = find.byType(Switch);
      await tester.tap(streamingToggle);
      await tester.pumpAndSettle();

      // å‘é€æ¶ˆæ¯
      final inputField = find.byType(TextField);
      await tester.enterText(inputField, 'Tell me a story');

      final sendButton = find.byIcon(Icons.send);
      await tester.tap(sendButton);

      // éªŒè¯æµå¼æŒ‡ç¤ºå™¨å‡ºç°
      expect(find.byType(CircularProgressIndicator), findsOneWidget);

      // ç­‰å¾…æµå¼å®Œæˆ
      await tester.pumpAndSettle(const Duration(seconds: 10));

      // éªŒè¯æœ€ç»ˆæ¶ˆæ¯
      expect(find.byType(CircularProgressIndicator), findsNothing);
    });
  });
}
```



## ğŸ¯ é¢„æœŸæˆæœ

### æ ¸å¿ƒé—®é¢˜è§£å†³
- âœ… å½»åº•è§£å†³é‡å¤è¯·æ±‚é—®é¢˜
- âœ… ç¡®ä¿å·¥å…·è°ƒç”¨ç»“æœæ­£ç¡®ä¼ é€’
- âœ… ä¿è¯æµå¼æ¶ˆæ¯å®Œæ•´æ€§
- âœ… æ¶ˆé™¤æ¶ˆæ¯é‡å¤ç°è±¡

### æ¶æ„ä¼˜åŒ–
- ğŸ“‰ Provideræ•°é‡ä»81ä¸ªå‡å°‘åˆ°45ä¸ªä»¥ä¸‹
- ğŸš€ çŠ¶æ€æ›´æ–°é¢‘ç‡é™ä½30%
- ğŸ’¾ å†…å­˜ä½¿ç”¨å‡å°‘20%
- âš¡ åº”ç”¨å¯åŠ¨æ—¶é—´å‡å°‘15%

### å¼€å‘æ•ˆç‡æå‡
- ğŸ§ª å•å…ƒæµ‹è¯•è¦†ç›–ç‡è¾¾åˆ°90%
- ğŸ“Š ä»£ç å¤æ‚åº¦é™ä½40%
- ğŸ› Bugæ•°é‡å‡å°‘60%
- ğŸ‘¥ å›¢é˜Ÿå¼€å‘æ•ˆç‡æå‡30%

## ï¿½ï¸ é£é™©æ§åˆ¶

### æŠ€æœ¯é£é™©ç¼“è§£
- **åŠŸèƒ½å¼€å…³** - æ¯ä¸ªæ–°åŠŸèƒ½éƒ½æœ‰ç‹¬ç«‹å¼€å…³ï¼Œæ”¯æŒå¿«é€Ÿå›æ»š
- **æ•°æ®å¤‡ä»½** - é‡æ„å‰è‡ªåŠ¨åˆ›å»ºå®Œæ•´æ•°æ®å¿«ç…§
- **æ¸è¿›å¼éƒ¨ç½²** - åˆ†é˜¶æ®µå®æ–½ï¼Œé€æ­¥éªŒè¯ç¨³å®šæ€§
- **æ€§èƒ½ç›‘æ§** - å®æ—¶ç›‘æ§å…³é”®æ€§èƒ½æŒ‡æ ‡

### æ•°æ®å®‰å…¨ä¿éšœ
- **è‡ªåŠ¨å¤‡ä»½** - æ¯æ¬¡é‡æ„å‰è‡ªåŠ¨å¤‡ä»½ç”¨æˆ·æ•°æ®
- **å®Œæ•´æ€§éªŒè¯** - è¿ç§»åéªŒè¯æ•°æ®å®Œæ•´æ€§
- **å¿«é€Ÿæ¢å¤** - æ”¯æŒä¸€é”®æ¢å¤åˆ°é‡æ„å‰çŠ¶æ€
- **ç‰ˆæœ¬å…¼å®¹** - ç¡®ä¿æ–°æ—§ç‰ˆæœ¬æ•°æ®æ ¼å¼å…¼å®¹

### å›æ»šç­–ç•¥
- **å¿«é€Ÿå›æ»š** - å‡ºç°é—®é¢˜æ—¶å¯åœ¨5åˆ†é’Ÿå†…å›æ»š
- **çŠ¶æ€ä¿å­˜** - ä¿ç•™ç”¨æˆ·å½“å‰æ“ä½œçŠ¶æ€
- **æ— æŸæ¢å¤** - å›æ»šè¿‡ç¨‹ä¸ä¼šä¸¢å¤±ç”¨æˆ·æ•°æ®
- **è‡ªåŠ¨æ£€æµ‹** - è‡ªåŠ¨æ£€æµ‹å¼‚å¸¸å¹¶è§¦å‘ä¿æŠ¤æœºåˆ¶

## ï¿½ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¼€å§‹
1. **å›¢é˜Ÿå¯¹é½** - ç¡®è®¤é‡æ„è®¡åˆ’å’Œæ—¶é—´å®‰æ’
2. **ç¯å¢ƒå‡†å¤‡** - è®¾ç½®å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ
3. **æ•°æ®å¤‡ä»½** - åˆ›å»ºå½“å‰çŠ¶æ€çš„å®Œæ•´å¤‡ä»½
4. **åŸºç¡€æ¶æ„** - å¼€å§‹ç¬¬ä¸€é˜¶æ®µçš„æ ¸å¿ƒçŠ¶æ€é‡æ„

### è¯¦ç»†è®¡åˆ’
å®Œæ•´çš„å®æ–½è®¡åˆ’ã€æ—¶é—´è¡¨å’ŒæˆåŠŸæŒ‡æ ‡è¯·å‚è€ƒï¼š[é‡æ„è®¡åˆ’è¯¦æƒ…](./é‡æ„è®¡åˆ’è¯¦æƒ….md)

## ğŸ‰ æ€»ç»“

è¿™ä¸ªé‡æ„è®¡åˆ’é‡‡ç”¨**èŠå¤©ä¼˜å…ˆã€åˆ†é˜¶æ®µå®æ–½**çš„ç­–ç•¥ï¼Œæ—¨åœ¨ï¼š

1. **è§£å†³æ ¸å¿ƒé—®é¢˜** - å½»åº•è§£å†³é‡å¤è¯·æ±‚ã€å·¥å…·è°ƒç”¨ã€æ¶ˆæ¯å®Œæ•´æ€§ç­‰å…³é”®é—®é¢˜
2. **ç®€åŒ–æ¶æ„** - å°†å¤æ‚çš„81ä¸ªProviderç²¾ç®€ä¸ºæ¸…æ™°çš„åˆ†å±‚æ¶æ„
3. **æå‡ä½“éªŒ** - å…¨é¢æå‡åº”ç”¨æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ
4. **å¥ å®šåŸºç¡€** - ä¸ºæœªæ¥å‘å±•å»ºç«‹åšå®çš„æŠ€æœ¯åŸºç¡€

é€šè¿‡è¿™ä¸ªé‡æ„ï¼Œyumchaå°†æ‹¥æœ‰ä¸€ä¸ªä¸–ç•Œçº§çš„çŠ¶æ€ç®¡ç†æ¶æ„ï¼Œç¡®ä¿åº”ç”¨çš„ç¨³å®šæ€§ã€æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚

## ğŸ” ä¸Cherry Studioå¯¹æ¯”åˆ†æ - èŠå¤©ä½“éªŒé—æ¼è¡¥å……

### æˆ‘çš„é‡æ„è®¡åˆ’é—æ¼çš„å…³é”®èŠå¤©ä½“éªŒçŠ¶æ€

ç»è¿‡æ·±å…¥å¯¹æ¯”Cherry Studioçš„çŠ¶æ€ç®¡ç†ï¼Œå‘ç°æˆ‘çš„é‡æ„è®¡åˆ’åœ¨ä»¥ä¸‹èŠå¤©ä½“éªŒæ–¹é¢å­˜åœ¨é‡è¦é—æ¼ï¼š

#### 1. æ¶ˆæ¯å—çŠ¶æ€ç®¡ç† âŒ **é‡å¤§é—æ¼**

**Cherry Studioçš„å®ç°**:
```typescript
// ç‹¬ç«‹çš„æ¶ˆæ¯å—çŠ¶æ€ç®¡ç†
interface MessageBlocksState extends EntityState<MessageBlock, string> {
  loadingState: 'idle' | 'loading' | 'succeeded' | 'failed'
  error: string | null
}

// æ”¯æŒçš„æ¶ˆæ¯å—ç±»å‹
enum MessageBlockType {
  MAIN_TEXT = 'main_text',
  THINKING = 'thinking',
  IMAGE = 'image',
  CODE = 'code',
  TOOL = 'tool_call',
  FILE = 'file',
  ERROR = 'error',
  CITATION = 'citation',
  TRANSLATION = 'translation'
}
```

**æˆ‘çš„è®¡åˆ’ç¼ºå¤±**:
- æ²¡æœ‰ç‹¬ç«‹çš„æ¶ˆæ¯å—çŠ¶æ€ç®¡ç†
- ç¼ºå°‘æ¶ˆæ¯å—ç±»å‹çš„å®Œæ•´å®šä¹‰
- æ²¡æœ‰æ¶ˆæ¯å—çº§åˆ«çš„çŠ¶æ€æ§åˆ¶

#### 2. è¿è¡Œæ—¶äº¤äº’çŠ¶æ€ âŒ **é‡å¤§é—æ¼**

**Cherry Studioçš„å®ç°**:
```typescript
interface ChatState {
  isMultiSelectMode: boolean        // å¤šé€‰æ¨¡å¼
  selectedMessageIds: string[]      // é€‰ä¸­çš„æ¶ˆæ¯ID
  activeTopic: Topic | null         // å½“å‰æ´»è·ƒè¯é¢˜
  renamingTopics: string[]          // æ­£åœ¨é‡å‘½åçš„è¯é¢˜
  newlyRenamedTopics: string[]      // æ–°é‡å‘½åçš„è¯é¢˜
}
```

**æˆ‘çš„è®¡åˆ’ç¼ºå¤±**:
- æ²¡æœ‰å¤šé€‰æ¨¡å¼çŠ¶æ€ç®¡ç†
- ç¼ºå°‘æ¶ˆæ¯é€‰æ‹©çŠ¶æ€
- æ²¡æœ‰è¯é¢˜é‡å‘½åçŠ¶æ€
- ç¼ºå°‘æ´»è·ƒè¯é¢˜ç®¡ç†

#### 3. æ¶ˆæ¯æ“ä½œçŠ¶æ€ âŒ **é‡å¤§é—æ¼**

**Cherry Studioçš„å®ç°**:
```typescript
// æ¶ˆæ¯æ“ä½œHooks
const useMessageOperations = (topic: Topic) => ({
  editMessage,           // ç¼–è¾‘æ¶ˆæ¯
  deleteMessage,         // åˆ é™¤æ¶ˆæ¯
  resendMessage,         // é‡å‘æ¶ˆæ¯
  regenerateAssistantMessage, // é‡æ–°ç”Ÿæˆ
  appendAssistantResponse,    // è¿½åŠ å“åº”
  createNewContext,      // åˆ›å»ºæ–°ä¸Šä¸‹æ–‡
  clearTopicMessages,    // æ¸…ç©ºè¯é¢˜æ¶ˆæ¯
  pauseMessages,         // æš‚åœæ¶ˆæ¯
  resumeMessage,         // æ¢å¤æ¶ˆæ¯
  createTopicBranch,     // åˆ›å»ºè¯é¢˜åˆ†æ”¯
})
```

**æˆ‘çš„è®¡åˆ’ç¼ºå¤±**:
- æ²¡æœ‰å®Œæ•´çš„æ¶ˆæ¯æ“ä½œçŠ¶æ€ç®¡ç†
- ç¼ºå°‘æ¶ˆæ¯ç¼–è¾‘çŠ¶æ€
- æ²¡æœ‰æ¶ˆæ¯åˆ†æ”¯ç®¡ç†
- ç¼ºå°‘æ¶ˆæ¯æš‚åœ/æ¢å¤çŠ¶æ€

#### 4. UIäº¤äº’çŠ¶æ€ âŒ **é‡å¤§é—æ¼**

**Cherry Studioçš„å®ç°**:
```typescript
// æ»šåŠ¨ä½ç½®ç®¡ç†
const useScrollPosition = () => {
  const [shouldAutoScroll, setShouldAutoScroll] = useState(true)
  const [scrollPosition, setScrollPosition] = useState(0)
}

// æœç´¢é«˜äº®çŠ¶æ€
const useContentSearch = () => {
  const [searchText, setSearchText] = useState('')
  const [highlightedElements, setHighlightedElements] = useState([])
  const [currentIndex, setCurrentIndex] = useState(0)
}

// è™šæ‹Ÿæ»šåŠ¨çŠ¶æ€
const useVirtualScroll = () => {
  const [visibleRange, setVisibleRange] = useState({ start: 0, end: 50 })
  const [itemHeights, setItemHeights] = useState(new Map())
}
```

**æˆ‘çš„è®¡åˆ’ç¼ºå¤±**:
- æ²¡æœ‰æ»šåŠ¨ä½ç½®çŠ¶æ€ç®¡ç†
- ç¼ºå°‘æœç´¢é«˜äº®çŠ¶æ€
- æ²¡æœ‰è™šæ‹Ÿæ»šåŠ¨çŠ¶æ€
- ç¼ºå°‘åˆ†é¡µåŠ è½½çŠ¶æ€

#### 5. å¤šæ¨¡å‹å¯¹è¯çŠ¶æ€ âŒ **é‡å¤§é—æ¼**

**Cherry Studioçš„å®ç°**:
```typescript
// æ¶ˆæ¯åˆ†ç»„çŠ¶æ€
interface MessageGroupState {
  multiModelMessageStyle: 'fold' | 'vertical' | 'horizontal' | 'grid'
  isGrouped: boolean
  selectedMessageId: string | null
  foldDisplayMode: 'compact' | 'expanded'
}
```

**æˆ‘çš„è®¡åˆ’ç¼ºå¤±**:
- æ²¡æœ‰å¤šæ¨¡å‹å¯¹è¯çŠ¶æ€
- ç¼ºå°‘æ¶ˆæ¯åˆ†ç»„æ˜¾ç¤ºæ¨¡å¼
- æ²¡æœ‰æ¶ˆæ¯ç»„é€‰æ‹©çŠ¶æ€

### ğŸ”§ è¡¥å……çš„çŠ¶æ€ç®¡ç†è®¾è®¡

#### 1. æ¶ˆæ¯å—çŠ¶æ€ç®¡ç†

**Cherry Studioå‚è€ƒ**:
- ğŸ“ `src/renderer/src/store/messageBlocks.ts` (ç¬¬1-262è¡Œ) - å®Œæ•´æ¶ˆæ¯å—çŠ¶æ€ç®¡ç†
- ğŸ“ `src/renderer/src/store/messageBlocks.ts` (ç¬¬14è¡Œ) - EntityAdapteræ¶ˆæ¯å—ç®¡ç†
- ğŸ“ `src/renderer/src/store/messageBlocks.ts` (ç¬¬32-56è¡Œ) - æ¶ˆæ¯å—CRUDæ“ä½œ
- ğŸ“ `src/renderer/src/pages/home/Messages/Blocks/index.tsx` (ç¬¬644-654è¡Œ) - 9ç§æ¶ˆæ¯å—ç±»å‹

```dart
// æ–°å¢ï¼šæ¶ˆæ¯å—çŠ¶æ€Provider
final messageBlockStateProvider = StateNotifierProvider<MessageBlockStateNotifier, MessageBlockState>(
  (ref) => MessageBlockStateNotifier(ref),
);

@freezed
class MessageBlockState with _$MessageBlockState {
  const factory MessageBlockState({
    @Default({}) Map<String, MessageBlock> blocks,
    @Default({}) Map<String, List<String>> messageBlockIds, // messageId -> blockIds
    @Default(MessageBlockLoadingState.idle) MessageBlockLoadingState loadingState,
    @Default(null) String? error,
    @Default({}) Map<String, MessageBlockStatus> blockStatuses,
  }) = _MessageBlockState;
}

enum MessageBlockType {
  mainText,    // ä¸»æ–‡æœ¬ - å¯¹åº”Cherry Studio MAIN_TEXT
  thinking,    // æ€è€ƒè¿‡ç¨‹ - å¯¹åº”Cherry Studio THINKING
  image,       // å›¾ç‰‡ - å¯¹åº”Cherry Studio IMAGE
  code,        // ä»£ç  - å¯¹åº”Cherry Studio CODE
  tool,        // å·¥å…·è°ƒç”¨ - å¯¹åº”Cherry Studio TOOL
  file,        // æ–‡ä»¶ - å¯¹åº”Cherry Studio FILE
  error,       // é”™è¯¯ - å¯¹åº”Cherry Studio ERROR
  citation,    // å¼•ç”¨ - å¯¹åº”Cherry Studio CITATION
  translation, // ç¿»è¯‘ - å¯¹åº”Cherry Studio TRANSLATION
}
```

#### 2. è¿è¡Œæ—¶äº¤äº’çŠ¶æ€

**Cherry Studioå‚è€ƒ**:
- ğŸ“ `src/renderer/src/store/runtime.ts` (ç¬¬6-14è¡Œ) - èŠå¤©è¿è¡Œæ—¶çŠ¶æ€æ¥å£
- ğŸ“ `src/renderer/src/store/runtime.ts` (ç¬¬717-732è¡Œ) - å¤šé€‰å’Œè¯é¢˜çŠ¶æ€ç®¡ç†
- ğŸ“ `src/renderer/src/pages/home/Messages/MessageGroup.tsx` (ç¬¬29-31è¡Œ) - æ¶ˆæ¯ç»„æœ¬åœ°çŠ¶æ€
- ğŸ“ `src/renderer/src/pages/home/Messages/MessageGroup.tsx` (ç¬¬63-64è¡Œ) - åˆ†ç»„é€»è¾‘

```dart
// æ–°å¢ï¼šè¿è¡Œæ—¶çŠ¶æ€Provider
final runtimeStateProvider = StateNotifierProvider<RuntimeStateNotifier, RuntimeState>(
  (ref) => RuntimeStateNotifier(ref),
);

@freezed
class RuntimeState with _$RuntimeState {
  const factory RuntimeState({
    // å¤šé€‰æ¨¡å¼ - å¯¹åº”Cherry Studio isMultiSelectMode
    @Default(false) bool isMultiSelectMode,
    @Default({}) Set<String> selectedMessageIds,

    // è¯é¢˜çŠ¶æ€ - å¯¹åº”Cherry Studio activeTopic
    @Default(null) String? activeTopicId,
    @Default({}) Set<String> renamingTopicIds,
    @Default({}) Set<String> newlyRenamedTopicIds,

    // ç¼–è¾‘çŠ¶æ€
    @Default(null) String? editingMessageId,
    @Default(null) String? editingContent,

    // æœç´¢çŠ¶æ€
    @Default(false) bool isSearching,
    @Default('') String searchQuery,
    @Default([]) List<SearchResult> searchResults,
    @Default(0) int currentSearchIndex,
  }) = _RuntimeState;
}
```

#### 3. UIäº¤äº’çŠ¶æ€

```dart
// æ–°å¢ï¼šUIçŠ¶æ€Provider
final uiStateProvider = StateNotifierProvider<UIStateNotifier, UIState>(
  (ref) => UIStateNotifier(ref),
);

@freezed
class UIState with _$UIState {
  const factory UIState({
    // æ»šåŠ¨çŠ¶æ€
    @Default(true) bool shouldAutoScroll,
    @Default(0.0) double scrollPosition,
    @Default(null) String? scrollToMessageId,

    // è™šæ‹Ÿæ»šåŠ¨
    @Default(0) int visibleStartIndex,
    @Default(50) int visibleEndIndex,
    @Default({}) Map<String, double> itemHeights,

    // åˆ†é¡µçŠ¶æ€
    @Default(false) bool isLoadingMore,
    @Default(true) bool hasMore,
    @Default(20) int pageSize,

    // ä¸»é¢˜å’Œæ ·å¼
    @Default(ThemeMode.system) ThemeMode themeMode,
    @Default(1.0) double fontSize,
    @Default(false) bool isCompactMode,
  }) = _UIState;
}
```

#### 4. æ¶ˆæ¯æ“ä½œçŠ¶æ€

```dart
// æ–°å¢ï¼šæ¶ˆæ¯æ“ä½œçŠ¶æ€Provider
final messageOperationStateProvider = StateNotifierProvider<MessageOperationStateNotifier, MessageOperationState>(
  (ref) => MessageOperationStateNotifier(ref),
);

@freezed
class MessageOperationState with _$MessageOperationState {
  const factory MessageOperationState({
    // æ“ä½œçŠ¶æ€
    @Default({}) Map<String, MessageOperationType> activeOperations,
    @Default({}) Map<String, double> operationProgress,
    @Default({}) Map<String, String> operationErrors,

    // åˆ†æ”¯ç®¡ç†
    @Default({}) Map<String, List<String>> messageBranches,
    @Default(null) String? activeBranchId,

    // æš‚åœ/æ¢å¤
    @Default({}) Set<String> pausedMessageIds,
    @Default({}) Set<String> resumableMessageIds,
  }) = _MessageOperationState;
}

enum MessageOperationType {
  editing,
  deleting,
  resending,
  regenerating,
  translating,
  branching,
}
```

#### 5. å¤šæ¨¡å‹å¯¹è¯çŠ¶æ€

```dart
// æ–°å¢ï¼šå¤šæ¨¡å‹å¯¹è¯çŠ¶æ€Provider
final multiModelStateProvider = StateNotifierProvider<MultiModelStateNotifier, MultiModelState>(
  (ref) => MultiModelStateNotifier(ref),
);

@freezed
class MultiModelState with _$MultiModelState {
  const factory MultiModelState({
    // æ˜¾ç¤ºæ¨¡å¼
    @Default(MultiModelDisplayMode.vertical) MultiModelDisplayMode displayMode,
    @Default(false) bool isGrouped,
    @Default(null) String? selectedMessageId,

    // ç½‘æ ¼å¸ƒå±€
    @Default(2) int gridColumns,
    @Default(GridPopoverTrigger.hover) GridPopoverTrigger popoverTrigger,

    // æŠ˜å æ¨¡å¼
    @Default(FoldDisplayMode.expanded) FoldDisplayMode foldDisplayMode,
  }) = _MultiModelState;
}

enum MultiModelDisplayMode {
  fold,       // æŠ˜å 
  vertical,   // å‚ç›´
  horizontal, // æ°´å¹³
  grid,       // ç½‘æ ¼
}
```

### ğŸ¯ æ›´æ–°åçš„æ¶æ„è®¾è®¡

#### æ ¸å¿ƒçŠ¶æ€å±‚ (10ä¸ªæ ¸å¿ƒProvider)

```dart
// åŸæœ‰çš„5ä¸ªæ ¸å¿ƒProvider
final chatStateProvider = StateNotifierProvider<ChatStateNotifier, ChatState>(...);
final streamingStateProvider = StateNotifierProvider<StreamingStateNotifier, StreamingState>(...);
final assistantStateProvider = StateNotifierProvider<AssistantStateNotifier, AssistantState>(...);
final providerStateProvider = StateNotifierProvider<ProviderStateNotifier, ProviderState>(...);
final appStateProvider = StateNotifierProvider<AppStateNotifier, AppState>(...);

// æ–°å¢çš„5ä¸ªæ ¸å¿ƒProvider
final messageBlockStateProvider = StateNotifierProvider<MessageBlockStateNotifier, MessageBlockState>(...);
final runtimeStateProvider = StateNotifierProvider<RuntimeStateNotifier, RuntimeState>(...);
final uiStateProvider = StateNotifierProvider<UIStateNotifier, UIState>(...);
final messageOperationStateProvider = StateNotifierProvider<MessageOperationStateNotifier, MessageOperationState>(...);
final multiModelStateProvider = StateNotifierProvider<MultiModelStateNotifier, MultiModelState>(...);
```

#### ä¾¿æ·è®¿é—®å±‚ (25-30ä¸ªProvider)

```dart
// æ¶ˆæ¯å—ç›¸å…³
final messageBlocksProvider = Provider<Map<String, MessageBlock>>((ref) {
  return ref.watch(messageBlockStateProvider.select((state) => state.blocks));
});

final messageBlocksByMessageProvider = Provider.family<List<MessageBlock>, String>((ref, messageId) {
  final blocks = ref.watch(messageBlocksProvider);
  final blockIds = ref.watch(messageBlockStateProvider.select((state) => state.messageBlockIds[messageId] ?? []));
  return blockIds.map((id) => blocks[id]).whereType<MessageBlock>().toList();
});

// è¿è¡Œæ—¶çŠ¶æ€ç›¸å…³
final isMultiSelectModeProvider = Provider<bool>((ref) {
  return ref.watch(runtimeStateProvider.select((state) => state.isMultiSelectMode));
});

final selectedMessageIdsProvider = Provider<Set<String>>((ref) {
  return ref.watch(runtimeStateProvider.select((state) => state.selectedMessageIds));
});

// UIçŠ¶æ€ç›¸å…³
final shouldAutoScrollProvider = Provider<bool>((ref) {
  return ref.watch(uiStateProvider.select((state) => state.shouldAutoScroll));
});

final isLoadingMoreProvider = Provider<bool>((ref) {
  return ref.watch(uiStateProvider.select((state) => state.isLoadingMore));
});

// æ¶ˆæ¯æ“ä½œç›¸å…³
final activeOperationsProvider = Provider<Map<String, MessageOperationType>>((ref) {
  return ref.watch(messageOperationStateProvider.select((state) => state.activeOperations));
});

// å¤šæ¨¡å‹å¯¹è¯ç›¸å…³
final multiModelDisplayModeProvider = Provider<MultiModelDisplayMode>((ref) {
  return ref.watch(multiModelStateProvider.select((state) => state.displayMode));
});
```

### ğŸ“Š æ›´æ–°åçš„é¢„æœŸæ”¶ç›Š

#### åŠŸèƒ½å®Œæ•´æ€§æå‡
- **æ¶ˆæ¯å—ç®¡ç†**: æ”¯æŒ9ç§æ¶ˆæ¯å—ç±»å‹ï¼Œç‹¬ç«‹çŠ¶æ€æ§åˆ¶
- **äº¤äº’ä½“éªŒ**: å®Œæ•´çš„å¤šé€‰ã€ç¼–è¾‘ã€æœç´¢ã€æ»šåŠ¨çŠ¶æ€ç®¡ç†
- **å¤šæ¨¡å‹å¯¹è¯**: æ”¯æŒ4ç§æ˜¾ç¤ºæ¨¡å¼ï¼Œçµæ´»çš„å¸ƒå±€æ§åˆ¶
- **æ¶ˆæ¯æ“ä½œ**: å®Œæ•´çš„ç¼–è¾‘ã€åˆ é™¤ã€é‡å‘ã€åˆ†æ”¯åŠŸèƒ½

#### æ€§èƒ½ä¼˜åŒ–å¢å¼º
- **è™šæ‹Ÿæ»šåŠ¨**: æ”¯æŒå¤§é‡æ¶ˆæ¯çš„é«˜æ€§èƒ½æ¸²æŸ“
- **æ™ºèƒ½ç¼“å­˜**: æ¶ˆæ¯å—çº§åˆ«çš„ç¼“å­˜ç­–ç•¥
- **åˆ†é¡µåŠ è½½**: æ¸è¿›å¼æ¶ˆæ¯åŠ è½½
- **çŠ¶æ€åˆ†ç¦»**: ç»†ç²’åº¦çš„çŠ¶æ€æ›´æ–°æ§åˆ¶

#### ç”¨æˆ·ä½“éªŒæå‡
- **æµç•…äº¤äº’**: å®Œæ•´çš„æ»šåŠ¨ã€æœç´¢ã€é€‰æ‹©ä½“éªŒ
- **çµæ´»å¸ƒå±€**: å¤šç§æ¶ˆæ¯æ˜¾ç¤ºæ¨¡å¼
- **æ™ºèƒ½æ“ä½œ**: å®Œæ•´çš„æ¶ˆæ¯æ“ä½œåŠŸèƒ½
- **å“åº”å¼è®¾è®¡**: é€‚é…ä¸åŒå±å¹•å°ºå¯¸

## ğŸ“š Cherry Studio ä»£ç å‚è€ƒç´¢å¼•

### æ ¸å¿ƒçŠ¶æ€ç®¡ç†æ–‡ä»¶
- ğŸ“ `src/renderer/src/store/index.ts` (ç¬¬1-98è¡Œ) - Redux Storeé…ç½®ä¸­å¿ƒ
- ğŸ“ `src/renderer/src/store/assistants.ts` (ç¬¬1-177è¡Œ) - åŠ©æ‰‹çŠ¶æ€ç®¡ç†
- ğŸ“ `src/renderer/src/store/llm.ts` (ç¬¬1-707è¡Œ) - AIæä¾›å•†çŠ¶æ€ç®¡ç†
- ğŸ“ `src/renderer/src/store/newMessage.ts` (ç¬¬1-277è¡Œ) - æ¶ˆæ¯çŠ¶æ€ç®¡ç†
- ğŸ“ `src/renderer/src/store/messageBlocks.ts` (ç¬¬1-262è¡Œ) - æ¶ˆæ¯å—çŠ¶æ€ç®¡ç†
- ğŸ“ `src/renderer/src/store/runtime.ts` (ç¬¬6-14è¡Œ) - è¿è¡Œæ—¶çŠ¶æ€ç®¡ç†
- ğŸ“ `src/renderer/src/store/settings.ts` (ç¬¬1-807è¡Œ) - åº”ç”¨è®¾ç½®ç®¡ç†

### æ¶ˆæ¯å—æ¸²æŸ“ç³»ç»Ÿ
- ğŸ“ `src/renderer/src/pages/home/Messages/Blocks/index.tsx` (ç¬¬1-171è¡Œ) - æ¶ˆæ¯å—æ¸²æŸ“å™¨
- ğŸ“ `src/renderer/src/pages/home/Messages/Blocks/MainTextBlock.tsx` (ç¬¬1-169è¡Œ) - ä¸»æ–‡æœ¬å—
- ğŸ“ `src/renderer/src/pages/home/Messages/MessageGroup.tsx` (ç¬¬1-300è¡Œ) - æ¶ˆæ¯ç»„ç®¡ç†

### èŠå¤©ç•Œé¢ç»„ä»¶
- ğŸ“ `src/renderer/src/pages/home/Chat.tsx` (ç¬¬1-159è¡Œ) - ä¸»èŠå¤©ç•Œé¢
- ğŸ“ `src/renderer/src/pages/home/Messages/Messages.tsx` (ç¬¬1-394è¡Œ) - æ¶ˆæ¯åˆ—è¡¨ç»„ä»¶

### æ•°æ®åº“å’ŒæœåŠ¡
- ğŸ“ `src/renderer/src/databases/index.ts` (ç¬¬1-78è¡Œ) - æ•°æ®åº“é…ç½®
- ğŸ“ `src/renderer/src/services/ApiService.ts` - APIè°ƒç”¨æœåŠ¡
- ğŸ“ `src/renderer/src/services/StreamProcessingService.ts` - æµå¼å¤„ç†æœåŠ¡
- ğŸ“ `src/renderer/src/services/StoreSyncService.ts` - å¤šçª—å£åŒæ­¥æœåŠ¡

### å…³é”®ç‰¹æ€§å®ç°
- **EntityAdapteræ¨¡å¼**: `messageBlocks.ts` (ç¬¬14è¡Œ) å’Œ `newMessage.ts` (ç¬¬7è¡Œ)
- **é€‰æ‹©å™¨ç¼“å­˜**: `newMessage.ts` (ç¬¬263-276è¡Œ) å’Œ `messageBlocks.ts` (ç¬¬257-262è¡Œ)
- **å¤šçª—å£åŒæ­¥**: `index.ts` (ç¬¬71-73è¡Œ)
- **æ¶ˆæ¯å—ç±»å‹**: `Blocks/index.tsx` (ç¬¬644-654è¡Œ)
- **å·¥å…·è°ƒç”¨å¤„ç†**: `messageBlocks.ts` (ç¬¬84-253è¡Œ)

è¯¦ç»†åˆ†æè¯·å‚è€ƒï¼š[Cherry Studio AIèŠå¤©çŠ¶æ€ç®¡ç†åˆ†æ](./Cherry_Studio_AIèŠå¤©çŠ¶æ€ç®¡ç†åˆ†æ.md)

---

*æœ¬é‡æ„è®¡åˆ’åŸºäºæ·±å…¥çš„é—®é¢˜åˆ†æå’ŒCherry Studioæœ€ä½³å®è·µåˆ¶å®šï¼Œç»è¿‡ä¸Cherry Studioçš„è¯¦ç»†å¯¹æ¯”ï¼Œè¡¥å……äº†å…³é”®çš„èŠå¤©ä½“éªŒçŠ¶æ€ç®¡ç†ï¼Œæ—¨åœ¨æ„å»ºä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€ä½“éªŒä¼˜ç§€çš„çŠ¶æ€ç®¡ç†æ¶æ„ã€‚*
